(()=>{var{defineProperty:fJ,getOwnPropertyNames:K6,getOwnPropertyDescriptor:Z6}=Object,Q6=Object.prototype.hasOwnProperty;var C1=new WeakMap,Y6=(J)=>{var K=C1.get(J),Z;if(K)return K;if(K=fJ({},"__esModule",{value:!0}),J&&typeof J==="object"||typeof J==="function")K6(J).map((Q)=>!Q6.call(K,Q)&&fJ(K,Q,{get:()=>J[Q],enumerable:!(Z=Z6(J,Q))||Z.enumerable}));return C1.set(J,K),K};var X6=(J,K)=>{for(var Z in K)fJ(J,Z,{get:K[Z],enumerable:!0,configurable:!0,set:(Q)=>K[Z]=()=>Q})};var E6={};X6(E6,{showLoader:()=>H0,showDialog:()=>G0,setPageTitle:()=>cJ,logOut:()=>gJ,hideLoader:()=>n});class h0 extends Error{constructor(J,K){super("APIError status "+J+`

`+JSON.stringify(K));this.code=J,this.json=K}}class SJ extends Error{}class r extends Error{}class jJ extends Error{}class $0{static async pdsEndpointForDid(J){let K;if(J.startsWith("did:plc:"))K=new URL(`https://plc.directory/${J}`);else if(J.startsWith("did:web:")){let z=J.replace(/^did:web:/,"");K=new URL(`https://${z}/.well-known/did.json`)}else throw new jJ("Unknown DID type: "+J);let Z=await fetch(K),Q=await Z.text(),X=Q.trim().length>0?JSON.parse(Q):void 0;if(Z.status==200){let z=(X.service||[]).find((W)=>W.id=="#atproto_pds");if(z)return z.serviceEndpoint.replace("https://","");else throw new jJ("Missing #atproto_pds service definition")}else throw new h0(Z.status,X)}constructor(J,K,Z){if(this.host=J,this.config=K,this.user=K?.user,this.sendAuthHeaders=!!this.user,this.autoManageTokens=!!this.user,Z)Object.assign(this,Z)}get baseURL(){if(this.host)return(this.host.includes("://")?this.host:`https://${this.host}`)+"/xrpc";else throw new SJ("Hostname not set")}get isLoggedIn(){return!!(this.user&&this.user.accessToken&&this.user.refreshToken&&this.user.did&&this.user.pdsEndpoint)}async getRequest(J,K,Z){let Q=new URL(`${this.baseURL}/${J}`),X=Z&&"auth"in Z?Z.auth:this.sendAuthHeaders;if(this.autoManageTokens&&X===!0)await this.checkAccess();if(K)for(let G in K)if(K[G]instanceof Array)K[G].forEach((F)=>Q.searchParams.append(G,F));else Q.searchParams.append(G,K[G]);let z=this.authHeaders(X);if(Z&&Z.headers)Object.assign(z,Z.headers);let W=await fetch(Q,{headers:z});return await this.parseResponse(W)}async postRequest(J,K,Z){let Q=`${this.baseURL}/${J}`,X=Z&&"auth"in Z?Z.auth:this.sendAuthHeaders;if(this.autoManageTokens&&X===!0)await this.checkAccess();let z={method:"POST",headers:this.authHeaders(X)};if(K)z.body=JSON.stringify(K),z.headers["Content-Type"]="application/json";if(Z&&Z.headers)Object.assign(z.headers,Z.headers);let W=await fetch(Q,z);return await this.parseResponse(W)}async fetchAll(J,K){if(!K||!K.field)throw new SJ("'field' option is required");let Z=[],Q=K.params??{},X=this.sliceOptions(K,["auth","headers"]);for(;;){let z=await this.getRequest(J,Q,X),W=z[K.field],G=z.cursor;if(K.breakWhen){let F=K.breakWhen;if(W.some((H)=>F(H))){if(!K.keepLastPage)W=W.filter((H)=>!F(H));G=null}}if(Z=Z.concat(W),Q.cursor=G,K.onPageLoad){if(K.onPageLoad(W)?.cancel)break}if(!G)break}return Z}authHeaders(J){if(typeof J=="string")return{Authorization:`Bearer ${J}`};else if(J)if(this.user?.accessToken)return{Authorization:`Bearer ${this.user.accessToken}`};else throw new r("Can't send auth headers, access token is missing");else return{}}sliceOptions(J,K){let Z={};for(let Q of K)if(Q in J)Z[Q]=J[Q];return Z}tokenExpirationTimestamp(J){let K=J.split(".");if(K.length!=3)throw new r("Invalid access token format");let Q=JSON.parse(atob(K[1])).exp;if(!(Q&&typeof Q=="number"&&Q>0))throw new r("Invalid token expiry data");return Q*1000}isInvalidToken(J,K){return J.status==400&&!!K&&["InvalidToken","ExpiredToken"].includes(K.error)}async parseResponse(J){let K=await J.text(),Z=K.trim().length>0?JSON.parse(K):void 0;if(J.status>=200&&J.status<300)return Z;else throw new h0(J.status,Z)}async checkAccess(){if(!this.isLoggedIn)throw new r("Not logged in");if(this.tokenExpirationTimestamp(this.user.accessToken)<new Date().getTime()+60000)await this.performTokenRefresh()}async logIn(J,K){if(!this.config||!this.config.user)throw new r("Missing user configuration object");let Z={identifier:J,password:K},Q=await this.postRequest("com.atproto.server.createSession",Z,{auth:!1});return this.saveTokens(Q),Q}async performTokenRefresh(){if(!this.isLoggedIn)throw new r("Not logged in");console.log("Refreshing access token…");let J=await this.postRequest("com.atproto.server.refreshSession",null,{auth:this.user.refreshToken});return this.saveTokens(J),J}saveTokens(J){if(!this.config||!this.config.user)throw new r("Missing user configuration object");if(this.user.accessToken=J.accessJwt,this.user.refreshToken=J.refreshJwt,this.user.did=J.did,J.didDoc?.service){let K=J.didDoc.service.find((Z)=>Z.id=="#atproto_pds");this.host=K.serviceEndpoint.replace("https://","")}this.user.pdsEndpoint=this.host,this.config.save()}resetTokens(){if(!this.config||!this.config.user)throw new r("Missing user configuration object");delete this.user.accessToken,delete this.user.refreshToken,delete this.user.did,delete this.user.pdsEndpoint,this.config.save()}}class P0 extends Error{constructor(J){super(J)}}class u{constructor(J,K){this.data=J,Object.assign(this,K??{})}get uri(){return this.data.uri}get cid(){return this.data.cid}get rkey(){return D(this.uri).rkey}get type(){return this.data.$type}}class k extends u{parent;threadRoot;pageRoot;grandparentAuthor;level;absoluteLevel;reason;isEmbed;static parseThreadPost(J,K=null,Z=0,Q=0){switch(J.$type){case"app.bsky.feed.defs#threadViewPost":let X=new k(J.post,{level:Z,absoluteLevel:Q});if(X.pageRoot=K??X,J.replies){let z=J.replies.map((W)=>k.parseThreadPost(W,X.pageRoot,Z+1,Q+1));X.setReplies(z)}if(Q<=0&&J.parent)X.parent=k.parseThreadPost(J.parent,X.pageRoot,Z-1,Q-1);return X;case"app.bsky.feed.defs#notFoundPost":return new i(J);case"app.bsky.feed.defs#blockedPost":return new a(J);default:throw new P0(`Unexpected record type: ${J.$type}`)}}static parseViewRecord(J){switch(J.$type){case"app.bsky.embed.record#viewRecord":return new k(J,{isEmbed:!0});case"app.bsky.embed.record#viewNotFound":return new i(J);case"app.bsky.embed.record#viewBlocked":return new a(J);case"app.bsky.embed.record#viewDetached":return new I0(J);case"app.bsky.feed.defs#generatorView":return new s0(J);case"app.bsky.graph.defs#listView":return new r0(J);case"app.bsky.graph.defs#starterPackViewBasic":return new a0(J);default:return console.warn("Unknown record type:",J.$type),new u(J)}}static parseFeedPost(J){let K=new k(J.post);if(J.reply){if(K.parent=k.parsePostView(J.reply.parent),K.threadRoot=k.parsePostView(J.reply.root),J.reply.grandparentAuthor)K.grandparentAuthor=J.reply.grandparentAuthor}if(J.reason)K.reason=J.reason;return K}static parsePostView(J){switch(J.$type){case"app.bsky.feed.defs#postView":return new k(J);case"app.bsky.feed.defs#notFoundPost":return new i(J);case"app.bsky.feed.defs#blockedPost":return new a(J);default:throw new P0(`Unexpected record type: ${J.$type}`)}}constructor(J,K){super(J);if(Object.assign(this,K??{}),this.absoluteLevel===0)this.pageRoot=this;if(this.record=this.isPostView?J.record:J.value,this.isPostView&&J.embed)this.embed=b.parseInlineEmbed(J.embed);else if(this.isEmbed&&J.embeds&&J.embeds[0])this.embed=b.parseInlineEmbed(J.embeds[0]);else if(this.record.embed)this.embed=b.parseRawEmbed(this.record.embed);if(this.author=this.author??J.author,this.replies=[],this.viewerData=J.viewer,this.viewerLike=J.viewer?.like,this.author)api.cacheProfile(this.author)}updateDataFromPost(J){this.record=J.record,this.embed=J.embed,this.author=J.author,this.replies=J.replies,this.viewerData=J.viewerData,this.viewerLike=J.viewerLike,this.level=J.level,this.absoluteLevel=J.absoluteLevel}setReplies(J){this.replies=J,this.replies.sort(this.sortReplies.bind(this))}sortReplies(J,K){if(J instanceof k&&K instanceof k)if(J.author.did==this.author.did&&K.author.did!=this.author.did)return-1;else if(J.author.did!=this.author.did&&K.author.did==this.author.did)return 1;else if(J.text!="\uD83D\uDCCC"&&K.text=="\uD83D\uDCCC")return-1;else if(J.text=="\uD83D\uDCCC"&&K.text!="\uD83D\uDCCC")return 1;else if(J.createdAt.getTime()<K.createdAt.getTime())return-1;else if(J.createdAt.getTime()>K.createdAt.getTime())return 1;else return 0;else if(J instanceof k)return-1;else if(K instanceof k)return 1;else return 0}get isPostView(){return!this.isEmbed}get isFediPost(){return this.author?.handle.endsWith(".ap.brid.gy")}get originalFediContent(){return this.record.bridgyOriginalText}get originalFediURL(){return this.record.bridgyOriginalUrl}get isRoot(){return this.pageRoot===this}get authorFediHandle(){if(this.isFediPost)return this.author.handle.replace(/\.ap\.brid\.gy$/,"").replace(".","@");else throw"Not a Fedi post"}get text(){return this.record.text}get lowercaseText(){if(!this._lowercaseText)this._lowercaseText=this.record.text.toLowerCase();return this._lowercaseText}get facets(){return this.record.facets}get tags(){return this.record.tags}get createdAt(){return new Date(this.record.createdAt)}get likeCount(){return O0(this.data.likeCount)}get replyCount(){return O0(this.data.replyCount)}get quoteCount(){return O0(this.data.quoteCount)}get hasMoreReplies(){return this.replyCount!==void 0&&this.replyCount>this.replies.length&&this.replies.length===0&&(this.level!==void 0&&this.level>4)}get hasHiddenReplies(){return this.replyCount!==void 0&&this.replyCount>this.replies.length&&(this.replies.length>0||this.level!==void 0&&this.level<=4)}get isRestrictingReplies(){return!!(this.data.threadgate&&this.data.threadgate.record.allow)}get repostCount(){return O0(this.data.repostCount)}get liked(){return this.viewerLike!==void 0}get muted(){return this.author.viewer?.muted}get muteList(){return this.author.viewer?.mutedByList?.name}get hasViewerInfo(){return this.viewerData!==void 0}get parentReference(){return this.record.reply?.parent&&new u(this.record.reply?.parent)}get rootReference(){return this.record.reply?.root&&new u(this.record.reply?.root)}}class a extends u{constructor(J){super(J);this.author=J.author}get blocksUser(){return!!this.author.viewer?.blocking}get blockedByUser(){return this.author.viewer?.blockedBy}}class i extends u{}class I0 extends u{}class s0 extends u{constructor(J){super(J);this.author=J.creator}get title(){return this.data.displayName}get description(){return this.data.description}get likeCount(){return O0(this.data.likeCount)}get avatar(){return this.data.avatar}}class r0 extends u{constructor(J){super(J);this.author=J.creator}get title(){return this.data.name}get purpose(){return this.data.purpose}get description(){return this.data.description}get avatar(){return this.data.avatar}}class a0 extends u{constructor(J){super(J);this.author=J.creator}get title(){return this.data.record.name}get description(){return this.data.record.description}}class b{static parseInlineEmbed(J){switch(J.$type){case"app.bsky.embed.record#view":return new ZJ(J);case"app.bsky.embed.recordWithMedia#view":return new QJ(J);case"app.bsky.embed.images#view":return new YJ(J);case"app.bsky.embed.external#view":return new f0(J);case"app.bsky.embed.video#view":return new XJ(J);default:if(location.protocol=="file:")throw new P0(`Unexpected embed type: ${J.$type}`);else return console.warn("Unexpected embed type:",J.$type),new b(J)}}static parseRawEmbed(J){switch(J.$type){case"app.bsky.embed.record":return new JJ(J);case"app.bsky.embed.recordWithMedia":return new KJ(J);case"app.bsky.embed.images":return new o0(J);case"app.bsky.embed.external":return new t0(J);case"app.bsky.embed.video":return new e0(J);default:if(location.protocol=="file:")throw new P0(`Unexpected embed type: ${J.$type}`);else return console.warn("Unexpected embed type:",J.$type),new b(J)}}constructor(J){this.json=J}get type(){return this.json.$type}}class o0 extends b{constructor(J){super(J);this.images=J.images}}class t0 extends b{constructor(J){super(J);this.url=J.external.uri,this.title=J.external.title,this.thumb=J.external.thumb}}class e0 extends b{constructor(J){super(J);this.video=J.video}}class JJ extends b{constructor(J){super(J);this.record=new u(J.record)}}class KJ extends b{constructor(J){super(J);this.record=new u(J.record.record),this.media=b.parseRawEmbed(J.media)}}class ZJ extends b{constructor(J){super(J);this.post=k.parseViewRecord(J.record)}}class QJ extends b{constructor(J){super(J);this.post=k.parseViewRecord(J.record.record),this.media=b.parseInlineEmbed(J.media)}}class f0 extends b{constructor(J){super(J);this.url=J.external.uri,this.title=J.external.title,this.description=J.external.description,this.thumb=J.external.thumb}}class YJ extends b{constructor(J){super(J);this.images=J.images}}class XJ extends b{constructor(J){super(J);this.playlistURL=J.playlist,this.alt=J.alt}}class DJ extends Error{}class B0 extends Error{constructor(J){super(J)}}class k1{prepareCache(){if(!this.cache)this.cache=JSON.parse(localStorage.getItem("handleCache")??"{}")}saveCache(){localStorage.setItem("handleCache",JSON.stringify(this.cache))}getHandleDid(J){return this.prepareCache(),this.cache[J]}setHandleDid(J,K){this.prepareCache(),this.cache[J]=K,this.saveCache()}findHandleByDid(J){this.prepareCache();let K=Object.entries(this.cache).find((Z)=>Z[1]==J);return K?K[0]:void 0}}class v1{constructor(){let J=localStorage.getItem("userData");this.user=J?JSON.parse(J):{}}save(){if(this.user)localStorage.setItem("userData",JSON.stringify(this.user));else localStorage.removeItem("userData")}}class A extends $0{constructor(J,K){super(J,K?new v1:void 0);this.handleCache=new k1,this.profiles={}}cacheProfile(J){this.profiles[J.did]=J,this.profiles[J.handle]=J,this.handleCache.setHandleDid(J.handle,J.did)}findHandleByDid(J){return this.handleCache.findHandleByDid(J)}async fetchHandleForDid(J){let K=this.handleCache.findHandleByDid(J);if(K)return K;else return(await this.loadUserProfile(J)).handle}static parsePostURL(J){let K;try{K=new URL(J)}catch(z){throw new B0(`${z}`)}if(K.protocol!="https:"&&K.protocol!="http:")throw new B0("URL must start with http(s)://");let Z=K.pathname.split("/");if(Z.length<5||Z[1]!="profile"||Z[3]!="post")throw new B0("This is not a valid thread URL");let Q=Z[2],X=Z[4];return[Q,X]}async resolveHandle(J){let K=this.handleCache.getHandleDid(J);if(K)return K;else{let Z=await this.getRequest("com.atproto.identity.resolveHandle",{handle:J},{auth:!1}),Q=Z.did;if(Q)return this.handleCache.setHandleDid(J,Q),Q;else throw new DJ("Missing DID in response: "+JSON.stringify(Z))}}async loadThreadByURL(J){let[K,Z]=A.parsePostURL(J);return await this.loadThreadById(K,Z)}async loadThreadById(J,K){let Q=`at://${J.startsWith("did:")?J:await this.resolveHandle(J)}/app.bsky.feed.post/${K}`;return await this.loadThreadByAtURI(Q)}async loadThreadByAtURI(J){return await this.getRequest("app.bsky.feed.getPostThread",{uri:J,depth:10})}async loadUserProfile(J){if(this.profiles[J])return this.profiles[J];else{let K=await this.getRequest("app.bsky.actor.getProfile",{actor:J});return this.cacheProfile(K),K}}async autocompleteUsers(J){return(await this.getRequest("app.bsky.actor.searchActorsTypeahead",{q:J})).actors}async getCurrentUserAvatar(){return(await this.getRequest("com.atproto.repo.getRecord",{repo:this.user.did,collection:"app.bsky.actor.profile",rkey:"self"})).value.avatar}async loadCurrentUserAvatar(){if(!this.config||!this.config.user)throw new r("User isn't logged in");let J=await this.getCurrentUserAvatar();if(J){let K=`https://cdn.bsky.app/img/avatar/plain/${this.user.did}/${J.ref.$link}@jpeg`;return this.config.user.avatar=K,this.config.save(),K}else return null}async getReplies(J){return(await this.getRequest("blue.feeds.post.getReplies",{uri:J})).replies}async getQuoteCount(J){return(await this.getRequest("blue.feeds.post.getQuoteCount",{uri:J})).quoteCount}async getQuotes(J,K=void 0){let Z;if(J.startsWith("at://"))Z=J;else{let[X,z]=A.parsePostURL(J);Z=`at://${X.startsWith("did:")?X:await appView.resolveHandle(X)}/app.bsky.feed.post/${z}`}let Q={uri:Z};if(K)Q.cursor=K;return await this.getRequest("blue.feeds.post.getQuotes",Q)}async getHashtagFeed(J,K=void 0){let Z={q:"#"+J,limit:50,sort:"latest"};if(K)Z.cursor=K;return await this.getRequest("app.bsky.feed.searchPosts",Z)}async loadNotifications(J){return await this.getRequest("app.bsky.notification.listNotifications",J||{})}async loadMentions(J){let K=await this.loadNotifications({cursor:J??"",limit:100,reasons:["reply","mention"]}),Z=K.notifications.map((z)=>z.uri),Q=[];for(let z=0;z<Z.length;z+=25){let W=this.loadPosts(Z.slice(z,z+25));Q.push(W)}let X=await Promise.all(Q);return{cursor:K.cursor,posts:X.flat()}}async loadHomeTimeline(J,K={}){let Q=new Date().getTime()-J*86400*1000;return await this.fetchAll("app.bsky.feed.getTimeline",{params:{limit:100},field:"feed",breakWhen:(X)=>l(X)<Q,onPageLoad:K.onPageLoad,keepLastPage:K.keepLastPage})}async loadUserTimeline(J,K,Z){let X=new Date().getTime()-K*86400*1000;return await this.fetchAll("app.bsky.feed.getAuthorFeed",{params:{actor:J,filter:Z.filter,limit:100},field:"feed",breakWhen:(z)=>l(z)<X,onPageLoad:Z.onPageLoad,keepLastPage:Z.keepLastPage})}async loadUserLists(){return(await this.fetchAll("app.bsky.graph.getLists",{params:{actor:this.user.did,limit:100},field:"lists"})).filter((K)=>K.purpose=="app.bsky.graph.defs#curatelist")}async loadListTimeline(J,K,Z={}){let X=new Date().getTime()-K*86400*1000;return await this.fetchAll("app.bsky.feed.getListFeed",{params:{list:J,limit:100},field:"feed",breakWhen:(z)=>l(z)<X,onPageLoad:Z.onPageLoad,keepLastPage:Z.keepLastPage})}async loadPost(J){let K=await this.loadPosts([J]);if(K.length==1)return K[0];else throw new DJ("Post not found")}async loadPostIfExists(J){return(await this.loadPosts([J]))[0]}async loadPosts(J){if(J.length>0)return(await this.getRequest("app.bsky.feed.getPosts",{uris:J})).posts;else return[]}async likePost(J){return await this.postRequest("com.atproto.repo.createRecord",{repo:this.user.did,collection:"app.bsky.feed.like",record:{subject:{uri:J.uri,cid:J.cid},createdAt:new Date().toISOString()}})}async removeLike(J){let{rkey:K}=D(J);await this.postRequest("com.atproto.repo.deleteRecord",{repo:this.user.did,collection:"app.bsky.feed.like",rkey:K})}resetTokens(){delete this.user.avatar,super.resetTokens()}}/*! @license DOMPurify 3.3.0 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/3.3.0/LICENSE */var{entries:b1,setPrototypeOf:M1,isFrozen:z6,getPrototypeOf:V6,getOwnPropertyDescriptor:W6}=Object,{freeze:T,seal:d,create:AJ}=Object,{apply:NJ,construct:_J}=typeof Reflect<"u"&&Reflect;if(!T)T=function(K){return K};if(!d)d=function(K){return K};if(!NJ)NJ=function(K,Z){for(var Q=arguments.length,X=Array(Q>2?Q-2:0),z=2;z<Q;z++)X[z-2]=arguments[z];return K.apply(Z,X)};if(!_J)_J=function(K){for(var Z=arguments.length,Q=Array(Z>1?Z-1:0),X=1;X<Z;X++)Q[X-1]=arguments[X];return new K(...Q)};var zJ=g(Array.prototype.forEach),B6=g(Array.prototype.lastIndexOf),$1=g(Array.prototype.pop),y0=g(Array.prototype.push),q6=g(Array.prototype.splice),WJ=g(String.prototype.toLowerCase),bJ=g(String.prototype.toString),RJ=g(String.prototype.match),A0=g(String.prototype.replace),G6=g(String.prototype.indexOf),H6=g(String.prototype.trim),o=g(Object.prototype.hasOwnProperty),E=g(RegExp.prototype.test),N0=F6(TypeError);function g(J){return function(K){if(K instanceof RegExp)K.lastIndex=0;for(var Z=arguments.length,Q=Array(Z>1?Z-1:0),X=1;X<Z;X++)Q[X-1]=arguments[X];return NJ(J,K,Q)}}function F6(J){return function(){for(var K=arguments.length,Z=Array(K),Q=0;Q<K;Q++)Z[Q]=arguments[Q];return _J(J,Z)}}function C(J,K){let Z=arguments.length>2&&arguments[2]!==void 0?arguments[2]:WJ;if(M1)M1(J,null);let Q=K.length;while(Q--){let X=K[Q];if(typeof X==="string"){let z=Z(X);if(z!==X){if(!z6(K))K[Q]=z;X=z}}J[X]=!0}return J}function U6(J){for(let K=0;K<J.length;K++)if(!o(J,K))J[K]=null;return J}function Y0(J){let K=AJ(null);for(let[Z,Q]of b1(J))if(o(J,Z))if(Array.isArray(Q))K[Z]=U6(Q);else if(Q&&typeof Q==="object"&&Q.constructor===Object)K[Z]=Y0(Q);else K[Z]=Q;return K}function _0(J,K){while(J!==null){let Q=W6(J,K);if(Q){if(Q.get)return g(Q.get);if(typeof Q.value==="function")return g(Q.value)}J=V6(J)}function Z(){return null}return Z}var O1=T(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","search","section","select","shadow","slot","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),LJ=T(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","enterkeyhint","exportparts","filter","font","g","glyph","glyphref","hkern","image","inputmode","line","lineargradient","marker","mask","metadata","mpath","part","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),hJ=T(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),w6=T(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),PJ=T(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),x6=T(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),I1=T(["#text"]),f1=T(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","exportparts","face","for","headers","height","hidden","high","href","hreflang","id","inert","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","part","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","slot","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),yJ=T(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","mask-type","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),S1=T(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),VJ=T(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),C6=d(/\{\{[\w\W]*|[\w\W]*\}\}/gm),k6=d(/<%[\w\W]*|[\w\W]*%>/gm),v6=d(/\$\{[\w\W]*/gm),M6=d(/^data-[\-\w.\u00B7-\uFFFF]+$/),$6=d(/^aria-[\-\w]+$/),R1=d(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),O6=d(/^(?:\w+script|data):/i),I6=d(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),L1=d(/^html$/i),f6=d(/^[a-z][.\w]*(-[.\w]+)+$/i),j1=Object.freeze({__proto__:null,ARIA_ATTR:$6,ATTR_WHITESPACE:I6,CUSTOM_ELEMENT:f6,DATA_ATTR:M6,DOCTYPE_NAME:L1,ERB_EXPR:k6,IS_ALLOWED_URI:R1,IS_SCRIPT_OR_DATA:O6,MUSTACHE_EXPR:C6,TMPLIT_EXPR:v6}),E0={element:1,attribute:2,text:3,cdataSection:4,entityReference:5,entityNode:6,progressingInstruction:7,comment:8,document:9,documentType:10,documentFragment:11,notation:12},S6=function(){return typeof window>"u"?null:window},j6=function(K,Z){if(typeof K!=="object"||typeof K.createPolicy!=="function")return null;let Q=null,X="data-tt-policy-suffix";if(Z&&Z.hasAttribute(X))Q=Z.getAttribute(X);let z="dompurify"+(Q?"#"+Q:"");try{return K.createPolicy(z,{createHTML(W){return W},createScriptURL(W){return W}})}catch(W){return console.warn("TrustedTypes policy "+z+" could not be created."),null}},D1=function(){return{afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}};function h1(){let J=arguments.length>0&&arguments[0]!==void 0?arguments[0]:S6(),K=(w)=>h1(w);if(K.version="3.3.0",K.removed=[],!J||!J.document||J.document.nodeType!==E0.document||!J.Element)return K.isSupported=!1,K;let{document:Z}=J,Q=Z,X=Q.currentScript,{DocumentFragment:z,HTMLTemplateElement:W,Node:G,Element:F,NodeFilter:H,NamedNodeMap:x=J.NamedNodeMap||J.MozNamedAttrMap,HTMLFormElement:M,DOMParser:m,trustedTypes:c}=J,t=F.prototype,$=_0(t,"cloneNode"),S=_0(t,"remove"),s=_0(t,"nextSibling"),T1=_0(t,"childNodes"),m0=_0(t,"parentNode");if(typeof W==="function"){let w=Z.createElement("template");if(w.content&&w.content.ownerDocument)Z=w.content.ownerDocument}let N,D0="",{implementation:BJ,createNodeIterator:g1,createDocumentFragment:m1,getElementsByTagName:c1}=Z,{importNode:p1}=Q,_=D1();K.isSupported=typeof b1==="function"&&typeof m0==="function"&&BJ&&BJ.createHTMLDocument!==void 0;let{MUSTACHE_EXPR:qJ,ERB_EXPR:GJ,TMPLIT_EXPR:HJ,DATA_ATTR:l1,ARIA_ATTR:u1,IS_SCRIPT_OR_DATA:i1,ATTR_WHITESPACE:nJ,CUSTOM_ELEMENT:n1}=j1,{IS_ALLOWED_URI:dJ}=j1,R=null,sJ=C({},[...O1,...LJ,...hJ,...PJ,...I1]),h=null,rJ=C({},[...f1,...yJ,...S1,...VJ]),I=Object.seal(AJ(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),b0=null,FJ=null,F0=Object.seal(AJ(null,{tagCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeCheck:{writable:!0,configurable:!1,enumerable:!0,value:null}})),aJ=!0,UJ=!0,oJ=!1,tJ=!0,U0=!1,c0=!0,V0=!1,wJ=!1,xJ=!1,w0=!1,p0=!1,l0=!1,eJ=!0,J1=!1,d1="user-content-",CJ=!0,R0=!1,x0={},C0=null,K1=C({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]),Z1=null,Q1=C({},["audio","video","img","source","image","track"]),kJ=null,Y1=C({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),u0="http://www.w3.org/1998/Math/MathML",i0="http://www.w3.org/2000/svg",K0="http://www.w3.org/1999/xhtml",k0=K0,vJ=!1,MJ=null,s1=C({},[u0,i0,K0],bJ),n0=C({},["mi","mo","mn","ms","mtext"]),d0=C({},["annotation-xml"]),r1=C({},["title","style","font","a","script"]),L0=null,a1=["application/xhtml+xml","text/html"],o1="text/html",L=null,v0=null,t1=Z.createElement("form"),X1=function(Y){return Y instanceof RegExp||Y instanceof Function},$J=function(){let Y=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(v0&&v0===Y)return;if(!Y||typeof Y!=="object")Y={};if(Y=Y0(Y),L0=a1.indexOf(Y.PARSER_MEDIA_TYPE)===-1?o1:Y.PARSER_MEDIA_TYPE,L=L0==="application/xhtml+xml"?bJ:WJ,R=o(Y,"ALLOWED_TAGS")?C({},Y.ALLOWED_TAGS,L):sJ,h=o(Y,"ALLOWED_ATTR")?C({},Y.ALLOWED_ATTR,L):rJ,MJ=o(Y,"ALLOWED_NAMESPACES")?C({},Y.ALLOWED_NAMESPACES,bJ):s1,kJ=o(Y,"ADD_URI_SAFE_ATTR")?C(Y0(Y1),Y.ADD_URI_SAFE_ATTR,L):Y1,Z1=o(Y,"ADD_DATA_URI_TAGS")?C(Y0(Q1),Y.ADD_DATA_URI_TAGS,L):Q1,C0=o(Y,"FORBID_CONTENTS")?C({},Y.FORBID_CONTENTS,L):K1,b0=o(Y,"FORBID_TAGS")?C({},Y.FORBID_TAGS,L):Y0({}),FJ=o(Y,"FORBID_ATTR")?C({},Y.FORBID_ATTR,L):Y0({}),x0=o(Y,"USE_PROFILES")?Y.USE_PROFILES:!1,aJ=Y.ALLOW_ARIA_ATTR!==!1,UJ=Y.ALLOW_DATA_ATTR!==!1,oJ=Y.ALLOW_UNKNOWN_PROTOCOLS||!1,tJ=Y.ALLOW_SELF_CLOSE_IN_ATTR!==!1,U0=Y.SAFE_FOR_TEMPLATES||!1,c0=Y.SAFE_FOR_XML!==!1,V0=Y.WHOLE_DOCUMENT||!1,w0=Y.RETURN_DOM||!1,p0=Y.RETURN_DOM_FRAGMENT||!1,l0=Y.RETURN_TRUSTED_TYPE||!1,xJ=Y.FORCE_BODY||!1,eJ=Y.SANITIZE_DOM!==!1,J1=Y.SANITIZE_NAMED_PROPS||!1,CJ=Y.KEEP_CONTENT!==!1,R0=Y.IN_PLACE||!1,dJ=Y.ALLOWED_URI_REGEXP||R1,k0=Y.NAMESPACE||K0,n0=Y.MATHML_TEXT_INTEGRATION_POINTS||n0,d0=Y.HTML_INTEGRATION_POINTS||d0,I=Y.CUSTOM_ELEMENT_HANDLING||{},Y.CUSTOM_ELEMENT_HANDLING&&X1(Y.CUSTOM_ELEMENT_HANDLING.tagNameCheck))I.tagNameCheck=Y.CUSTOM_ELEMENT_HANDLING.tagNameCheck;if(Y.CUSTOM_ELEMENT_HANDLING&&X1(Y.CUSTOM_ELEMENT_HANDLING.attributeNameCheck))I.attributeNameCheck=Y.CUSTOM_ELEMENT_HANDLING.attributeNameCheck;if(Y.CUSTOM_ELEMENT_HANDLING&&typeof Y.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements==="boolean")I.allowCustomizedBuiltInElements=Y.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements;if(U0)UJ=!1;if(p0)w0=!0;if(x0){if(R=C({},I1),h=[],x0.html===!0)C(R,O1),C(h,f1);if(x0.svg===!0)C(R,LJ),C(h,yJ),C(h,VJ);if(x0.svgFilters===!0)C(R,hJ),C(h,yJ),C(h,VJ);if(x0.mathMl===!0)C(R,PJ),C(h,S1),C(h,VJ)}if(Y.ADD_TAGS)if(typeof Y.ADD_TAGS==="function")F0.tagCheck=Y.ADD_TAGS;else{if(R===sJ)R=Y0(R);C(R,Y.ADD_TAGS,L)}if(Y.ADD_ATTR)if(typeof Y.ADD_ATTR==="function")F0.attributeCheck=Y.ADD_ATTR;else{if(h===rJ)h=Y0(h);C(h,Y.ADD_ATTR,L)}if(Y.ADD_URI_SAFE_ATTR)C(kJ,Y.ADD_URI_SAFE_ATTR,L);if(Y.FORBID_CONTENTS){if(C0===K1)C0=Y0(C0);C(C0,Y.FORBID_CONTENTS,L)}if(CJ)R["#text"]=!0;if(V0)C(R,["html","head","body"]);if(R.table)C(R,["tbody"]),delete b0.tbody;if(Y.TRUSTED_TYPES_POLICY){if(typeof Y.TRUSTED_TYPES_POLICY.createHTML!=="function")throw N0('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if(typeof Y.TRUSTED_TYPES_POLICY.createScriptURL!=="function")throw N0('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');N=Y.TRUSTED_TYPES_POLICY,D0=N.createHTML("")}else{if(N===void 0)N=j6(c,X);if(N!==null&&typeof D0==="string")D0=N.createHTML("")}if(T)T(Y);v0=Y},z1=C({},[...LJ,...hJ,...w6]),V1=C({},[...PJ,...x6]),e1=function(Y){let q=m0(Y);if(!q||!q.tagName)q={namespaceURI:k0,tagName:"template"};let U=WJ(Y.tagName),O=WJ(q.tagName);if(!MJ[Y.namespaceURI])return!1;if(Y.namespaceURI===i0){if(q.namespaceURI===K0)return U==="svg";if(q.namespaceURI===u0)return U==="svg"&&(O==="annotation-xml"||n0[O]);return Boolean(z1[U])}if(Y.namespaceURI===u0){if(q.namespaceURI===K0)return U==="math";if(q.namespaceURI===i0)return U==="math"&&d0[O];return Boolean(V1[U])}if(Y.namespaceURI===K0){if(q.namespaceURI===i0&&!d0[O])return!1;if(q.namespaceURI===u0&&!n0[O])return!1;return!V1[U]&&(r1[U]||!z1[U])}if(L0==="application/xhtml+xml"&&MJ[Y.namespaceURI])return!0;return!1},e=function(Y){y0(K.removed,{element:Y});try{m0(Y).removeChild(Y)}catch(q){S(Y)}},W0=function(Y,q){try{y0(K.removed,{attribute:q.getAttributeNode(Y),from:q})}catch(U){y0(K.removed,{attribute:null,from:q})}if(q.removeAttribute(Y),Y==="is")if(w0||p0)try{e(q)}catch(U){}else try{q.setAttribute(Y,"")}catch(U){}},W1=function(Y){let q=null,U=null;if(xJ)Y="<remove></remove>"+Y;else{let j=RJ(Y,/^[\r\n\t ]+/);U=j&&j[0]}if(L0==="application/xhtml+xml"&&k0===K0)Y='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+Y+"</body></html>";let O=N?N.createHTML(Y):Y;if(k0===K0)try{q=new m().parseFromString(O,L0)}catch(j){}if(!q||!q.documentElement){q=BJ.createDocument(k0,"template",null);try{q.documentElement.innerHTML=vJ?D0:O}catch(j){}}let y=q.body||q.documentElement;if(Y&&U)y.insertBefore(Z.createTextNode(U),y.childNodes[0]||null);if(k0===K0)return c1.call(q,V0?"html":"body")[0];return V0?q.documentElement:y},B1=function(Y){return g1.call(Y.ownerDocument||Y,Y,H.SHOW_ELEMENT|H.SHOW_COMMENT|H.SHOW_TEXT|H.SHOW_PROCESSING_INSTRUCTION|H.SHOW_CDATA_SECTION,null)},OJ=function(Y){return Y instanceof M&&(typeof Y.nodeName!=="string"||typeof Y.textContent!=="string"||typeof Y.removeChild!=="function"||!(Y.attributes instanceof x)||typeof Y.removeAttribute!=="function"||typeof Y.setAttribute!=="function"||typeof Y.namespaceURI!=="string"||typeof Y.insertBefore!=="function"||typeof Y.hasChildNodes!=="function")},q1=function(Y){return typeof G==="function"&&Y instanceof G};function Z0(w,Y,q){zJ(w,(U)=>{U.call(K,Y,q,v0)})}let G1=function(Y){let q=null;if(Z0(_.beforeSanitizeElements,Y,null),OJ(Y))return e(Y),!0;let U=L(Y.nodeName);if(Z0(_.uponSanitizeElement,Y,{tagName:U,allowedTags:R}),c0&&Y.hasChildNodes()&&!q1(Y.firstElementChild)&&E(/<[/\w!]/g,Y.innerHTML)&&E(/<[/\w!]/g,Y.textContent))return e(Y),!0;if(Y.nodeType===E0.progressingInstruction)return e(Y),!0;if(c0&&Y.nodeType===E0.comment&&E(/<[/\w]/g,Y.data))return e(Y),!0;if(!(F0.tagCheck instanceof Function&&F0.tagCheck(U))&&(!R[U]||b0[U])){if(!b0[U]&&F1(U)){if(I.tagNameCheck instanceof RegExp&&E(I.tagNameCheck,U))return!1;if(I.tagNameCheck instanceof Function&&I.tagNameCheck(U))return!1}if(CJ&&!C0[U]){let O=m0(Y)||Y.parentNode,y=T1(Y)||Y.childNodes;if(y&&O){let j=y.length;for(let p=j-1;p>=0;--p){let Q0=$(y[p],!0);Q0.__removalCount=(Y.__removalCount||0)+1,O.insertBefore(Q0,s(Y))}}}return e(Y),!0}if(Y instanceof F&&!e1(Y))return e(Y),!0;if((U==="noscript"||U==="noembed"||U==="noframes")&&E(/<\/no(script|embed|frames)/i,Y.innerHTML))return e(Y),!0;if(U0&&Y.nodeType===E0.text){if(q=Y.textContent,zJ([qJ,GJ,HJ],(O)=>{q=A0(q,O," ")}),Y.textContent!==q)y0(K.removed,{element:Y.cloneNode()}),Y.textContent=q}return Z0(_.afterSanitizeElements,Y,null),!1},H1=function(Y,q,U){if(eJ&&(q==="id"||q==="name")&&((U in Z)||(U in t1)))return!1;if(UJ&&!FJ[q]&&E(l1,q));else if(aJ&&E(u1,q));else if(F0.attributeCheck instanceof Function&&F0.attributeCheck(q,Y));else if(!h[q]||FJ[q])if(F1(Y)&&(I.tagNameCheck instanceof RegExp&&E(I.tagNameCheck,Y)||I.tagNameCheck instanceof Function&&I.tagNameCheck(Y))&&(I.attributeNameCheck instanceof RegExp&&E(I.attributeNameCheck,q)||I.attributeNameCheck instanceof Function&&I.attributeNameCheck(q,Y))||q==="is"&&I.allowCustomizedBuiltInElements&&(I.tagNameCheck instanceof RegExp&&E(I.tagNameCheck,U)||I.tagNameCheck instanceof Function&&I.tagNameCheck(U)));else return!1;else if(kJ[q]);else if(E(dJ,A0(U,nJ,"")));else if((q==="src"||q==="xlink:href"||q==="href")&&Y!=="script"&&G6(U,"data:")===0&&Z1[Y]);else if(oJ&&!E(i1,A0(U,nJ,"")));else if(U)return!1;return!0},F1=function(Y){return Y!=="annotation-xml"&&RJ(Y,n1)},U1=function(Y){Z0(_.beforeSanitizeAttributes,Y,null);let{attributes:q}=Y;if(!q||OJ(Y))return;let U={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:h,forceKeepAttr:void 0},O=q.length;while(O--){let y=q[O],{name:j,namespaceURI:p,value:Q0}=y,M0=L(j),IJ=Q0,P=j==="value"?IJ:H6(IJ);if(U.attrName=M0,U.attrValue=P,U.keepAttr=!0,U.forceKeepAttr=void 0,Z0(_.uponSanitizeAttribute,Y,U),P=U.attrValue,J1&&(M0==="id"||M0==="name"))W0(j,Y),P=d1+P;if(c0&&E(/((--!?|])>)|<\/(style|title|textarea)/i,P)){W0(j,Y);continue}if(M0==="attributename"&&RJ(P,"href")){W0(j,Y);continue}if(U.forceKeepAttr)continue;if(!U.keepAttr){W0(j,Y);continue}if(!tJ&&E(/\/>/i,P)){W0(j,Y);continue}if(U0)zJ([qJ,GJ,HJ],(x1)=>{P=A0(P,x1," ")});let w1=L(Y.nodeName);if(!H1(w1,M0,P)){W0(j,Y);continue}if(N&&typeof c==="object"&&typeof c.getAttributeType==="function")if(p);else switch(c.getAttributeType(w1,M0)){case"TrustedHTML":{P=N.createHTML(P);break}case"TrustedScriptURL":{P=N.createScriptURL(P);break}}if(P!==IJ)try{if(p)Y.setAttributeNS(p,j,P);else Y.setAttribute(j,P);if(OJ(Y))e(Y);else $1(K.removed)}catch(x1){W0(j,Y)}}Z0(_.afterSanitizeAttributes,Y,null)},J6=function w(Y){let q=null,U=B1(Y);Z0(_.beforeSanitizeShadowDOM,Y,null);while(q=U.nextNode())if(Z0(_.uponSanitizeShadowNode,q,null),G1(q),U1(q),q.content instanceof z)w(q.content);Z0(_.afterSanitizeShadowDOM,Y,null)};return K.sanitize=function(w){let Y=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},q=null,U=null,O=null,y=null;if(vJ=!w,vJ)w="<!-->";if(typeof w!=="string"&&!q1(w))if(typeof w.toString==="function"){if(w=w.toString(),typeof w!=="string")throw N0("dirty is not a string, aborting")}else throw N0("toString is not a function");if(!K.isSupported)return w;if(!wJ)$J(Y);if(K.removed=[],typeof w==="string")R0=!1;if(R0){if(w.nodeName){let Q0=L(w.nodeName);if(!R[Q0]||b0[Q0])throw N0("root node is forbidden and cannot be sanitized in-place")}}else if(w instanceof G)if(q=W1("<!---->"),U=q.ownerDocument.importNode(w,!0),U.nodeType===E0.element&&U.nodeName==="BODY")q=U;else if(U.nodeName==="HTML")q=U;else q.appendChild(U);else{if(!w0&&!U0&&!V0&&w.indexOf("<")===-1)return N&&l0?N.createHTML(w):w;if(q=W1(w),!q)return w0?null:l0?D0:""}if(q&&xJ)e(q.firstChild);let j=B1(R0?w:q);while(O=j.nextNode())if(G1(O),U1(O),O.content instanceof z)J6(O.content);if(R0)return w;if(w0){if(p0){y=m1.call(q.ownerDocument);while(q.firstChild)y.appendChild(q.firstChild)}else y=q;if(h.shadowroot||h.shadowrootmode)y=p1.call(Q,y,!0);return y}let p=V0?q.outerHTML:q.innerHTML;if(V0&&R["!doctype"]&&q.ownerDocument&&q.ownerDocument.doctype&&q.ownerDocument.doctype.name&&E(L1,q.ownerDocument.doctype.name))p="<!DOCTYPE "+q.ownerDocument.doctype.name+`>
`+p;if(U0)zJ([qJ,GJ,HJ],(Q0)=>{p=A0(p,Q0," ")});return N&&l0?N.createHTML(p):p},K.setConfig=function(){let w=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};$J(w),wJ=!0},K.clearConfig=function(){v0=null,wJ=!1},K.isValidAttribute=function(w,Y,q){if(!v0)$J({});let U=L(w),O=L(Y);return H1(U,O,q)},K.addHook=function(w,Y){if(typeof Y!=="function")return;y0(_[w],Y)},K.removeHook=function(w,Y){if(Y!==void 0){let q=B6(_[w],Y);return q===-1?void 0:q6(_[w],q,1)[0]}return $1(_[w])},K.removeHooks=function(w){_[w]=[]},K.removeAllHooks=function(){_=D1()},K}var P1=h1();class y1{constructor(J){if(!J.startsWith("at://"))throw new B0(`Not an at:// URI: ${J}`);let K=J.split("/");if(K.length!=5)throw new B0(`Invalid at:// URI: ${J}`);this.repo=K[2],this.collection=K[3],this.rkey=K[4]}}function v(J,K){return document.getElementById(J)}function B(J,K){return J}function D(J){return new y1(J)}function O0(J){if(J===void 0||J===null||typeof J=="number")return J;else return parseInt(J,10)}function A1(J){return J.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function l(J){let K=J.reason?J.reason.indexedAt:J.post.record.createdAt;return Date.parse(K)}function N1(J){return P1.sanitize(J,{ALLOWED_TAGS:["a","b","blockquote","br","code","dd","del","div","dl","dt","em","font","h1","h2","h3","h4","h5","h6","hr","i","li","ol","p","q","pre","s","span","strong","sub","sup","u","wbr","#text"],ALLOWED_ATTR:["align","alt","class","clear","color","dir","href","lang","rel","title","translate"]})}function X0(){return location.origin+location.pathname}function z0(J){console.log(J),alert(J)}function _1(J,K){return J.getDate()==K.getDate()&&J.getMonth()==K.getMonth()&&J.getFullYear()==K.getFullYear()}function q0(J){return J0(J.author.handle,J.rkey)}function J0(J,K){let Z=new URL(X0());return Z.searchParams.set("author",J),Z.searchParams.set("post",K),Z.toString()}function V(J,K,Z){let Q,X=J.split(".");if(X.length>1){let z=X[0];Q=document.createElement(z),Q.className=X.slice(1).join(" ")}else Q=document.createElement(J);if(typeof K==="string")Q.className=Q.className+" "+K;else if(K)for(let z in K)if(z=="text")Q.innerText=K[z];else if(z=="html")Q.innerHTML=K[z];else Q[z]=K[z];return Q}class S0{constructor(J,K){this.post=J,this.embed=K}buildElement(){if(this.embed instanceof JJ){let J=this.quotedPostPlaceholder();return this.loadQuotedPost(this.embed.record.uri,J),J}else if(this.embed instanceof KJ){let J=V("div"),K=new S0(this.post,this.embed.media).buildElement(),Z=this.quotedPostPlaceholder();return this.loadQuotedPost(this.embed.record.uri,Z),J.append(K,Z),J}else if(this.embed instanceof ZJ)return this.buildQuotedPostElement(this.embed);else if(this.embed instanceof QJ){let J=V("div"),K=new S0(this.post,this.embed.media).buildElement(),Z=this.buildQuotedPostElement(this.embed);return J.append(K,Z),J}else if(this.embed instanceof o0||this.embed instanceof YJ)return this.buildImagesComponent(this.embed);else if(this.embed instanceof t0||this.embed instanceof f0)return this.buildLinkComponent(this.embed);else if(this.embed instanceof e0||this.embed instanceof XJ)return this.buildVideoComponent(this.embed);else return V("p",{text:`[${this.embed.type}]`})}quotedPostPlaceholder(){return V("div.quote-embed",{html:'<p class="post placeholder">Loading quoted post...</p>'})}buildQuotedPostElement(J){let K=V("div.quote-embed");if([k,a,i,I0].some((Z)=>J.post instanceof Z)){let Z=new f(J.post,"quote").buildElement();K.appendChild(Z)}else if(J.post instanceof s0)return this.buildFeedGeneratorView(J.post);else if(J.post instanceof r0)return this.buildUserListView(J.post);else if(J.post instanceof a0)return this.buildStarterPackView(J.post);else{let Z=V("p",{text:`[${J.post.type}]`});K.appendChild(Z)}return K}buildLinkComponent(J){let K;try{K=new URL(J.url).hostname}catch(W){console.log("Invalid URL:"+W);let G=V("a",{href:J.url,text:J.title||J.url}),F=V("p");return F.append("[Link: ",G,"]"),F}let Z=V("a.link-card",{href:J.url,target:"_blank"}),Q=V("div"),X=V("p.domain",{text:K}),z=V("h2",{text:J.title||J.url});if(Q.append(X,z),J.description){let W;if(J.description.length<=300)W=J.description;else W=J.description.slice(0,300)+"…";Q.append(V("p.description",{text:W}))}if(Z.append(Q),K=="media.tenor.com")Z.addEventListener("click",(W)=>{W.preventDefault(),this.displayGIFInline(Z,J)});return Z}displayGIFInline(J,K){let Z=V("div.gif"),Q=V("img",{src:K.url},HTMLImageElement);Q.style.opacity="0",Q.style.maxHeight="200px",Z.append(Q),J.replaceWith(Z),Q.addEventListener("load",(z)=>{if(Q.naturalWidth>Q.naturalHeight)Q.style.maxHeight="200px";else Q.style.maxWidth="200px",Q.style.maxHeight="400px";Q.style.opacity=""});let X;if(typeof K.thumb=="string")X=K.thumb;else X=`https://cdn.bsky.app/img/avatar/plain/${this.post.author.did}/${K.thumb.ref.$link}@jpeg`;Q.addEventListener("click",(z)=>{if(Q.classList.contains("static"))Q.src=K.url,Q.classList.remove("static");else Q.src=X,Q.classList.add("static")})}buildFeedGeneratorView(J){let K=this.linkToFeedGenerator(J),Z=V("a.link-card.record",{href:K,target:"_blank"}),Q=V("div");if(J.avatar){let W=V("img.avatar",HTMLImageElement);W.src=J.avatar,Q.append(W)}let X=V("h2",{text:J.title});if(X.append(V("span.handle",{text:`• Feed by @${J.author.handle}`})),Q.append(X),J.description){let W=V("p.description",{text:J.description});Q.append(W)}let z=V("p.stats");return z.append(V("i","fa-solid fa-heart")," "),z.append(V("output",{text:J.likeCount})),Q.append(z),Z.append(Q),Z}linkToFeedGenerator(J){let{repo:K,rkey:Z}=D(J.uri);return`https://bsky.app/profile/${K}/feed/${Z}`}buildUserListView(J){let K=this.linkToUserList(J),Z=V("a.link-card.record",{href:K,target:"_blank"}),Q=V("div");if(J.avatar){let W=V("img.avatar",HTMLImageElement);W.src=J.avatar,Q.append(W)}let X;switch(J.purpose){case"app.bsky.graph.defs#curatelist":X="User list";break;case"app.bsky.graph.defs#modlist":X="Mute list";break;default:X="List"}let z=V("h2",{text:J.title});if(z.append(V("span.handle",{text:`• ${X} by @${J.author.handle}`})),Q.append(z),J.description){let W=V("p.description",{text:J.description});Q.append(W)}return Z.append(Q),Z}buildStarterPackView(J){let{repo:K,rkey:Z}=D(J.uri),Q=`https://bsky.app/starter-pack/${K}/${Z}`,X=V("a.link-card.record",{href:Q,target:"_blank"}),z=V("div"),W=V("h2",{text:J.title});if(W.append(V("span.handle",{text:`• Starter pack by @${J.author.handle}`})),z.append(W),J.description){let G=V("p.description",{text:J.description});z.append(G)}return X.append(z),X}linkToUserList(J){let{repo:K,rkey:Z}=D(J.uri);return`https://bsky.app/profile/${K}/lists/${Z}`}buildImagesComponent(J){let K=V("div");for(let Z of J.images){let Q=V("p");Q.append("[");let X=V("a",{text:"Image"},HTMLLinkElement);if(Z.fullsize)X.href=Z.fullsize;else{let z=Z.image.ref.$link;X.href=`https://cdn.bsky.app/img/feed_fullsize/plain/${this.post.author.did}/${z}@jpeg`}if(Q.append(X),Q.append("] "),K.append(Q),Z.alt){let z=V("details.image-alt");z.append(V("summary",{text:"Show alt"}),Z.alt),K.appendChild(z)}}return K}buildVideoComponent(J){let K=V("div"),Z=V("a",{text:"Video"},HTMLLinkElement);if(J.playlistURL)Z.href=J.playlistURL;else{let X=J.video.ref.$link;Z.href=`https://video.bsky.app/watch/${this.post.author.did}/${X}/playlist.m3u8`}let Q=V("p");if(Q.append("[",Z,"]"),K.append(Q),J.alt){let X=V("details.image-alt");X.append(V("summary",{text:"Show alt"}),J.alt),K.appendChild(X)}return K}async loadQuotedPost(J,K){let Z=await api.loadPostIfExists(J);if(Z){let Q=new k(Z),X=new f(Q,"quote").buildElement();K.replaceChildren(X)}else{let Q=new i(this.embed.record),X=new f(Q,"quote").buildElement();K.replaceChildren(X)}}}class j0{constructor(J,K){this.text=J,this.facet=K}get link(){return this.facet?.features?.find((J)=>J.$type==="app.bsky.richtext.facet#link")}get mention(){return this.facet?.features?.find((J)=>J.$type==="app.bsky.richtext.facet#mention")}get tag(){return this.facet?.features?.find((J)=>J.$type==="app.bsky.richtext.facet#tag")}}class EJ{constructor(J){if(this.unicodeText=new T0(J.text),this.facets=J.facets,this.facets)this.facets.sort((K,Z)=>K.index.byteStart-Z.index.byteStart)}get text(){return this.unicodeText.toString()}get length(){return this.unicodeText.length}get graphemeLength(){return this.unicodeText.graphemeLength}*segments(){let J=this.facets||[];if(J.length==0){yield new j0(this.unicodeText.utf16);return}let K=0,Z=0;do{let Q=J[Z];if(K<Q.index.byteStart)yield new j0(this.unicodeText.slice(K,Q.index.byteStart));else if(K>Q.index.byteStart){Z++;continue}if(Q.index.byteStart<Q.index.byteEnd){let X=this.unicodeText.slice(Q.index.byteStart,Q.index.byteEnd);if(X.trim().length==0)yield new j0(X);else yield new j0(X,Q)}K=Q.index.byteEnd,Z++}while(Z<J.length);if(K<this.unicodeText.length)yield new j0(this.unicodeText.slice(K,this.unicodeText.length))}}class T0{static encoder=new TextEncoder;static decoder=new TextDecoder;static segmenter=window.Intl&&Intl.Segmenter&&new Intl.Segmenter;constructor(J){this.utf16=J,this.utf8=T0.encoder.encode(J)}get length(){return this.utf8.byteLength}get graphemeLength(){return Array.from(T0.segmenter.segment(this.utf16)).length}slice(J,K){return T0.decoder.decode(this.utf8.slice(J,K))}toString(){return this.utf16}}class f{_rootElement;constructor(J,K){this.post=J,this.context=K}get rootElement(){if(!this._rootElement)throw Error("rootElement not initialized");return this._rootElement}get isRoot(){return this.post.isRoot}get linkToAuthor(){if(this.post.author.handle!="handle.invalid")return"https://bsky.app/profile/"+this.post.author.handle;else return"https://bsky.app/profile/"+this.post.author.did}get linkToPost(){return this.linkToAuthor+"/post/"+this.post.rkey}get didLinkToAuthor(){let{repo:J}=D(this.post.uri);return`https://bsky.app/profile/${J}`}get didLinkToPost(){let{repo:J,rkey:K}=D(this.post.uri);return`https://bsky.app/profile/${J}/post/${K}`}get authorName(){if(this.post.author.displayName)return this.post.author.displayName;else if(this.post.author.handle.endsWith(".bsky.social"))return this.post.author.handle.replace(/\.bsky\.social$/,"");else return this.post.author.handle}get timeFormatForTimestamp(){if(this.context=="quotes"||this.context=="feed")return{weekday:"short",day:"numeric",month:"short",year:"numeric",hour:"numeric",minute:"numeric"};else if(this.isRoot||this.context!="thread")return{day:"numeric",month:"short",year:"numeric",hour:"numeric",minute:"numeric"};else if(this.post.pageRoot&&!_1(this.post.createdAt,this.post.pageRoot.createdAt))return{day:"numeric",month:"short",hour:"numeric",minute:"numeric"};else return{hour:"numeric",minute:"numeric"}}installIntoElement(J){let K=this.buildElement(),Z=B(J.querySelector(".content")),Q=B(K.querySelector(".content"));Z.replaceWith(Q),this._rootElement=J}buildElement(){if(this._rootElement)return this._rootElement;let J=V("div.post",`post-${this.context}`);if(this._rootElement=J,this.post.muted)J.classList.add("muted");if(this.post instanceof a)return this.buildBlockedPostElement(J),J;else if(this.post instanceof I0)return this.buildDetachedQuoteElement(J),J;else if(this.post instanceof i)return this.buildMissingPostElement(J),J;let K=this.buildPostHeader();J.appendChild(K);let Z=V("div.content");if(this.context=="thread"&&!this.isRoot){let z=this.buildEdgeMargin();J.appendChild(z)}let Q;if(this.post.muted){let z=V("details"),W=V("summary");W.innerText=this.post.muteList?`Muted (${this.post.muteList})`:"Muted - click to show",z.appendChild(W),Z.appendChild(z),Q=z}else Q=Z;let X=this.buildPostBody();if(Q.appendChild(X),this.post.tags){let z=this.buildTagsRow(this.post.tags);Q.appendChild(z)}if(this.post.embed){let z=new S0(this.post,this.post.embed).buildElement();if(Q.appendChild(z),this.post.originalFediURL){if(this.post.embed instanceof f0&&this.post.embed.title.startsWith("Original post on "))z.remove()}}if(this.post.originalFediURL){let z=this.buildFediSourceLink(this.post.originalFediURL);if(z)Q.appendChild(z)}if(this.post.likeCount!==void 0&&this.post.repostCount!==void 0){let z=this.buildStatsFooter();Q.appendChild(z)}if(this.post.replyCount==1&&this.post.replies[0]?.author?.did==this.post.author.did){let W=new f(this.post.replies[0],"thread").buildElement();W.classList.add("flat"),Z.appendChild(W)}else for(let z of this.post.replies){if(z instanceof i)continue;if(z instanceof a&&window.biohazardEnabled===!1)continue;let W=new f(z,"thread");Z.appendChild(W.buildElement())}if(this.context=="thread"){if(this.post.hasMoreReplies){let z=this.buildLoadMoreLink();Z.appendChild(z)}else if(this.post.hasHiddenReplies&&window.biohazardEnabled!==!1){let z=this.buildHiddenRepliesLink();Z.appendChild(z)}}return J.appendChild(Z),J}buildPostHeader(){let J=this.timeFormatForTimestamp,K=this.post.createdAt.toLocaleString(window.dateLocale,J),Z=this.post.createdAt.toISOString(),Q=V("h2");if(Q.innerHTML=`${A1(this.authorName)} `,this.post.isFediPost){let X=`@${this.post.authorFediHandle}`;Q.innerHTML+=`<a class="handle" href="${this.linkToAuthor}" target="_blank">${X}</a> <img src="icons/mastodon.svg" class="mastodon"> `}else{let X=this.post.author.handle!="handle.invalid"?`@${this.post.author.handle}`:"[invalid handle]";Q.innerHTML+=`<a class="handle" href="${this.linkToAuthor}" target="_blank">${X}</a> `}if(Q.innerHTML+=`<span class="separator">&bull;</span> <a class="time" href="${this.linkToPost}" target="_blank" title="${Z}">${K}</a> `,this.post.replyCount>0&&!this.isRoot||["quote","quotes","feed"].includes(this.context))Q.innerHTML+=`<span class="separator">&bull;</span> <a href="${q0(this.post)}" class="action" title="Load this subtree"><i class="fa-solid fa-arrows-split-up-and-left fa-rotate-180"></i></a> `;if(this.post.muted)Q.prepend(V("i","missing fa-regular fa-circle-user fa-2x"));else if(this.post.author.avatar)Q.prepend(this.buildUserAvatar(this.post.author.avatar));else Q.prepend(V("i","missing fa-regular fa-face-smile fa-2x"));return Q}buildEdgeMargin(){let J=V("div.margin"),K=V("div.edge"),Z=V("div.line");K.appendChild(Z),J.appendChild(K);let Q=V("img.plus",{src:"icons/subtract-square.png"});return J.appendChild(Q),[K,Q].forEach((X)=>{X.addEventListener("click",(z)=>{z.preventDefault(),this.toggleSectionFold()})}),J}buildUserAvatar(J){let K=V("img.avatar",{loading:"lazy"},HTMLImageElement);return K.src=J,window.avatarPreloader.observe(K),K}buildPostBody(){if(this.post.originalFediContent)return V("div.body",{html:N1(this.post.originalFediContent)});let J=V("p.body"),K=new EJ({text:this.post.text,facets:this.post.facets});for(let Z of K.segments())if(Z.mention)J.append(V("a",{href:`https://bsky.app/profile/${Z.mention.did}`,text:Z.text}));else if(Z.link)J.append(V("a",{href:Z.link.uri,text:Z.text}));else if(Z.tag){let Q=new URL(X0());Q.searchParams.set("hash",Z.tag.tag),J.append(V("a",{href:Q.toString(),text:Z.text}))}else if(Z.text.includes(`
`)){let Q=V("span",{text:Z.text});Q.innerHTML=Q.innerHTML.replaceAll(`
`,"<br>"),J.append(Q)}else J.append(Z.text);return J}highlightSearchResults(J){let K=new RegExp(`\\b(${J.join("|")})\\b`,"gi"),Z=this.rootElement,Q=B(Z.querySelector(":scope > .content > .body, :scope > .content > details .body")),X=document.createTreeWalker(Q,NodeFilter.SHOW_TEXT),z=[];while(X.nextNode())z.push(X.currentNode);for(let W of z){if(!W.textContent)continue;let G=document.createDocumentFragment(),F=0;for(;;){let H=K.exec(W.textContent);if(H===null)break;if(H.index>F){let M=W.textContent.slice(F,H.index);G.appendChild(document.createTextNode(M))}let x=V("span.highlight",{text:H[0]});G.appendChild(x),F=H.index+H[0].length}if(F<W.textContent.length){let H=W.textContent.slice(F);G.appendChild(document.createTextNode(H))}B(W.parentNode).replaceChild(G,W)}}buildTagsRow(J){let K=V("p.tags");for(let Z of J){let Q=new URL(X0());Q.searchParams.set("hash",Z);let X=V("a",{href:Q.toString(),text:"# "+Z});K.append(X)}return K}buildStatsFooter(){let J=V("p.stats"),K=V("span"),Z=V("i","fa-solid fa-heart "+(this.post.liked?"liked":""));if(Z.addEventListener("click",(Q)=>this.onHeartClick(Z)),K.append(Z," ",V("output",{text:this.post.likeCount})),J.append(K),this.post.repostCount>0){let Q=V("span",{html:`<i class="fa-solid fa-retweet"></i> ${this.post.repostCount}`});J.append(Q)}if(this.post.replyCount>0&&(this.context=="quotes"||this.context=="feed")){let Q=this.post.replyCount>1?`${this.post.replyCount} replies`:"1 reply",X=V("span",{html:`<i class="fa-regular fa-message"></i> <a href="${q0(this.post)}">${Q}</a>`});J.append(X)}if(!this.isRoot&&this.context!="quote"&&this.post.quoteCount){let Q=this.context=="quotes"||this.context=="feed",X=this.buildQuotesIconLink(this.post.quoteCount,Q);J.append(X)}if(this.context=="thread"&&this.post.isRestrictingReplies){let Q=V("span",{html:'<i class="fa-solid fa-ban"></i> Limited replies'});J.append(Q)}return J}buildQuotesIconLink(J,K){let Z=new URL(X0());Z.searchParams.set("quotes",this.linkToPost);let Q=Z.toString(),X='<i class="fa-regular fa-comments"></i>';if(K){let z=V("span",{html:`${X} `}),W=V("a",{text:J>1?`${J} quotes`:"1 quote",href:Q});return z.append(W),z}else return V("a",{html:`${X} ${J}`,href:Q})}appendQuotesIconLink(J,K){let Z=B(this.rootElement.querySelector(":scope > .content > p.stats")),Q=this.buildQuotesIconLink(J,K);Z.append(Q)}buildLoadMoreLink(){let J=V("p"),K=V("a",{href:q0(this.post),text:"Load more replies…"});return K.addEventListener("click",(Z)=>{Z.preventDefault(),J.innerHTML='<img class="loader" src="icons/sunny.png">',this.loadSubtree(this.post,this.rootElement)}),J.appendChild(K),J}buildHiddenRepliesLink(){let J=V("p.hidden-replies"),K=V("a",{href:q0(this.post),text:"Load hidden replies…"});return K.addEventListener("click",(Z)=>{if(Z.preventDefault(),window.biohazardEnabled===!0)this.loadHiddenReplies(J);else window.loadInfohazard=()=>this.loadHiddenReplies(J),G0(v("biohazard_dialog"))}),J.append("☣️ ",K),J}loadHiddenReplies(J){J.innerHTML='<img class="loader" src="icons/sunny.png">',this.loadHiddenSubtree(this.post,this.rootElement)}buildFediSourceLink(J){try{let K=new URL(J).hostname,Z=V("a.fedi-link",{href:J,target:"_blank"}),Q=V("div",{html:`<i class="fa-solid fa-arrow-up-right-from-square fa-sm"></i> View on ${K}`});return Z.append(Q),Z}catch(K){console.log("Invalid Fedi URL:"+K);return}}loadReferencedPostAuthor(J){let K=D(this.post.uri).repo;api.fetchHandleForDid(K).then((Z)=>{if(this.post.author)this.post.author.handle=Z;else this.post.author={did:K,handle:Z};J.href=this.linkToAuthor,J.innerText=`@${Z}`})}buildBlockedPostElement(J){let K=V("p.blocked-header");if(K.innerHTML='<i class="fa-solid fa-ban"></i> <span>Blocked post</span>',window.biohazardEnabled===!1)return J.appendChild(K),J.classList.add("blocked"),K;let Z=this.post.blockedByUser?"has blocked you":this.post.blocksUser?"you've blocked them":"";Z=Z?`, ${Z}`:"";let Q=V("a",{href:this.didLinkToAuthor,target:"_blank",text:"see author"},HTMLLinkElement);K.append(" (",Q,Z,") "),J.appendChild(K),this.loadReferencedPostAuthor(Q);let X=V("p.load-post"),z=V("a",{href:"#",text:"Load post…"});return z.addEventListener("click",(W)=>{W.preventDefault(),X.innerHTML="&nbsp;",this.loadBlockedPost(this.post.uri,J)}),X.appendChild(z),J.appendChild(X),J.classList.add("blocked"),J}buildDetachedQuoteElement(J){let K=V("p.blocked-header");if(K.innerHTML='<i class="fa-solid fa-ban"></i> <span>Hidden quote</span>',window.biohazardEnabled===!1)return J.appendChild(K),J.classList.add("blocked"),K;let Z=V("a",{href:this.didLinkToAuthor,target:"_blank",text:"see author"},HTMLLinkElement);K.append(" (",Z,") "),J.appendChild(K),this.loadReferencedPostAuthor(Z);let Q=V("p.load-post"),X=V("a",{href:"#",text:"Load post…"});return X.addEventListener("click",(z)=>{z.preventDefault(),Q.innerHTML="&nbsp;",this.loadBlockedPost(this.post.uri,J)}),Q.appendChild(X),J.appendChild(Q),J.classList.add("blocked"),J}buildMissingPostElement(J){let K=V("p.blocked-header");K.innerHTML='<i class="fa-solid fa-ban"></i> <span>Deleted post</span>';let Z=V("a",{href:this.didLinkToAuthor,target:"_blank",text:"see author"},HTMLLinkElement);return K.append(" (",Z,") "),this.loadReferencedPostAuthor(Z),J.appendChild(K),J.classList.add("blocked"),J}async loadBlockedPost(J,K){let Z=await appView.loadPostIfExists(this.post.uri);if(!Z){let W=new i({uri:this.post.uri}),G=new f(W,"quote").buildElement();K.replaceWith(G);return}this.post=new k(Z);let Q=await api.getRequest("app.bsky.actor.getProfile",{actor:this.post.author.did});if(!Q.viewer||!(Q.viewer.blockedBy||Q.viewer.blocking)){let{repo:W,rkey:G}=D(this.post.uri),F=V("a",{href:J0(W,G),className:"action",title:"Load thread",html:'<i class="fa-solid fa-arrows-split-up-and-left fa-rotate-180"></i>'}),H=B(K.querySelector("p.blocked-header")),x=V("span.separator",{html:"&bull;"});H.append(x," ",F)}if(B(K.querySelector("p.load-post")).remove(),this.isRoot&&this.post.parentReference){let{repo:W,rkey:G}=D(this.post.parentReference.uri),F=J0(W,G),H=api.findHandleByDid(W),x=H?`See parent post (@${H})`:"See parent post",M=V("p.back",{html:`<i class="fa-solid fa-reply"></i><a href="${F}">${x}</a>`});K.appendChild(M)}let z=this.buildPostBody();if(K.appendChild(z),this.post.embed){let W=new S0(this.post,this.post.embed).buildElement();K.appendChild(W),Array.from(K.querySelectorAll("a.link-card")).forEach((G)=>G.remove())}}async loadSubtree(J,K){try{let Z=await api.loadThreadByAtURI(J.uri),Q=k.parseThreadPost(Z.thread,J.pageRoot,0,J.absoluteLevel);J.updateDataFromPost(Q),window.subtreeRoot=J,new f(J,"thread").installIntoElement(K)}catch(Z){z0(Z)}}async loadHiddenSubtree(J,K){let Z=B(K.querySelector(".content")),Q=B(Z.querySelector(":scope > .hidden-replies"));try{var X=await blueAPI.getReplies(J.uri)}catch(H){if(Q.remove(),H instanceof h0&&H.code==404){let x=V("p.missing-replies-info",{html:'<i class="fa-solid fa-ban"></i> Hidden replies not available (post too old)'});Z.append(x)}else setTimeout(()=>z0(H),1);return}let W=X.filter((H)=>!J.replies.some((x)=>x.uri===H)).map((H)=>api.loadThreadByAtURI(H));try{var G=await Promise.allSettled(W)}catch(H){Q.remove(),setTimeout(()=>z0(H),1);return}let F=G.map((H)=>H.status=="fulfilled"?H.value:void 0).filter((H)=>H).map((H)=>k.parseThreadPost(H.thread,J.pageRoot,1,J.absoluteLevel+1));J.setReplies(F),Q.remove();for(let H of J.replies){let M=new f(H,"thread").buildElement();Z.append(M)}if(F.length<G.length){let H=G.length-F.length,x=H>1?`${H} replies are`:"1 reply is",M=V("p.missing-replies-info",{html:`<i class="fa-solid fa-ban"></i> ${x} missing (likely taken down by moderation)`});Z.append(M)}}isCollapsed(){return this.rootElement.classList.contains("collapsed")}toggleSectionFold(){let J=B(this.rootElement.querySelector(":scope > .margin .plus"),HTMLImageElement);if(this.isCollapsed())this.rootElement.classList.remove("collapsed"),J.src="icons/subtract-square.png";else this.rootElement.classList.add("collapsed"),J.src="icons/add-square.png"}async onHeartClick(J){try{if(!this.post.hasViewerInfo)if(accountAPI.isLoggedIn)if(await this.loadViewerInfo()){if(this.post.liked){J.classList.add("liked");return}}else{this.showPostAsBlocked();return}else{G0(loginDialog);return}let K=B(J.nextElementSibling),Z=parseInt(K.innerText,10);if(!J.classList.contains("liked")){let Q=await accountAPI.likePost(this.post);this.post.viewerLike=Q.uri,J.classList.add("liked"),K.innerText=String(Z+1)}else await accountAPI.removeLike(this.post.viewerLike),this.post.viewerLike=void 0,J.classList.remove("liked"),K.innerText=String(Z-1)}catch(K){z0(K)}}showPostAsBlocked(){let J=B(this.rootElement.querySelector(":scope > .content > p.stats"));if(!J.querySelector(".blocked-info")){let K=V("span.blocked-info",{text:"\uD83D\uDEAB Post unavailable"});J.append(K)}}async loadViewerInfo(){let J=await accountAPI.loadPostIfExists(this.post.uri);if(J)this.post.author=J.author,this.post.viewerData=J.viewer,this.post.viewerLike=J.viewer?.like;return J}}class TJ{constructor(){this.menuElement=v("account_menu"),this.icon=v("account"),this.setupEvents()}setupEvents(){B(document.body.parentNode).addEventListener("click",(Z)=>{this.menuElement.style.visibility="hidden",this.icon.classList.remove("active")});let K=B(this.menuElement.querySelector('a[href="?"]'),HTMLLinkElement);K.href=location.origin+location.pathname,this.icon.addEventListener("click",(Z)=>{Z.stopPropagation(),this.toggleAccountMenu()}),this.menuElement.addEventListener("click",(Z)=>{Z.stopPropagation()}),B(this.menuElement.querySelector("a[data-action=biohazard]")).addEventListener("click",(Z)=>{Z.preventDefault();let Q=document.querySelectorAll("p.hidden-replies, .content > .post.blocked, .blocked > .load-post");if(window.biohazardEnabled===!1)window.biohazardEnabled=!0,localStorage.setItem("biohazard","true"),this.toggleMenuButtonCheck("biohazard",!0),Array.from(Q).forEach((X)=>{B(X).style.display="block"});else window.biohazardEnabled=!1,localStorage.setItem("biohazard","false"),this.toggleMenuButtonCheck("biohazard",!1),Array.from(Q).forEach((X)=>{B(X).style.display="none"})}),B(this.menuElement.querySelector("a[data-action=incognito]")).addEventListener("click",(Z)=>{if(Z.preventDefault(),window.isIncognito)localStorage.removeItem("incognito");else localStorage.setItem("incognito","1");location.reload()}),B(this.menuElement.querySelector("a[data-action=login]")).addEventListener("click",(Z)=>{Z.preventDefault(),G0(loginDialog),this.menuElement.style.visibility="hidden"}),B(this.menuElement.querySelector("a[data-action=logout]")).addEventListener("click",(Z)=>{Z.preventDefault(),gJ()})}toggleAccountMenu(){let J=this.menuElement.style.visibility=="visible";this.menuElement.style.visibility=J?"hidden":"visible",this.icon.classList.toggle("active",!J)}showMenuButton(J){let K=B(this.menuElement.querySelector(`a[data-action=${J}]`)),Z=B(K.parentNode);Z.style.display="list-item"}hideMenuButton(J){let K=B(this.menuElement.querySelector(`a[data-action=${J}]`)),Z=B(K.parentNode);Z.style.display="none"}toggleMenuButtonCheck(J,K){let Z=B(this.menuElement.querySelector(`a[data-action=${J}]`)),Q=B(Z.querySelector(".check"));Q.style.display=K?"inline":"none"}showLoggedInStatus(J,K){if(J===!0&&K){let Z=B(this.icon.querySelector("i")),Q=V("img.avatar",{src:K});Q.style.display="none",Q.addEventListener("load",()=>{Z.remove(),Q.style.display="inline"}),Q.addEventListener("error",()=>{this.showLoggedInStatus(!0,null)}),this.icon.append(Q)}else if(J===!1)this.icon.innerHTML='<i class="fa-regular fa-user-circle fa-xl"></i>';else if(J==="incognito")this.icon.innerHTML='<i class="fa-solid fa-user-secret fa-lg"></i>';else this.icon.innerHTML='<i class="fa-solid fa-user-circle fa-xl"></i>'}async loadCurrentUserAvatar(){try{let J=await api.loadCurrentUserAvatar();this.showLoggedInStatus(!0,J)}catch(J){console.log(J),this.showLoggedInStatus(!0,null)}}}class mJ{buildParentLink(J){let K=V("p.back");if(J instanceof a){let Z=new f(J,"parent").buildElement();Z.className="back";let Q=B(Z.querySelector("p.blocked-header span"));return Q.innerText="Parent post blocked",Z}else if(J instanceof i)K.innerHTML='<i class="fa-solid fa-ban"></i> parent post has been deleted';else{let Z=q0(J);K.innerHTML=`<i class="fa-solid fa-reply"></i><a href="${Z}">See parent post (@${J.author.handle})</a>`}return K}async loadThreadByURL(J){try{let K=J.startsWith("at://")?await api.loadThreadByAtURI(J):await api.loadThreadByURL(J);this.displayThread(K)}catch(K){n(),z0(K)}}async loadThreadById(J,K){try{let Z=await api.loadThreadById(J,K);this.displayThread(Z)}catch(Z){n(),z0(Z)}}displayThread(J){let K=k.parseThreadPost(J.thread);window.root=K,window.subtreeRoot=K;let Z;if(K instanceof k){if(cJ(K),Z=blueAPI.getQuoteCount(K.uri),K.parent){let z=this.buildParentLink(K.parent);v("thread").appendChild(z)}else if(K.parentReference){let{repo:z,rkey:W}=D(K.parentReference.uri),G=J0(z,W),F=api.findHandleByDid(z),H=F?`See parent post (@${F})`:"See parent post",x=V("p.back",{html:`<i class="fa-solid fa-reply"></i><a href="${G}">${H}</a>`});v("thread").appendChild(x)}}let Q=new f(K,"thread"),X=Q.buildElement();n(),v("thread").appendChild(X),Z?.then((z)=>{if(z>0)Q.appendQuotesIconLink(z,!0)}).catch((z)=>{console.warn("Couldn't load quote count: "+z)})}}class pJ{scanStartTime;userProgress;autocompleteTimer;autocompleteIndex=-1;autocompleteResults=[];selectedUsers={};constructor(){this.pageElement=v("posting_stats_page"),this.form=B(this.pageElement.querySelector("form"),HTMLFormElement),this.rangeInput=B(this.pageElement.querySelector('input[type="range"]'),HTMLInputElement),this.submitButton=B(this.pageElement.querySelector('input[type="submit"]'),HTMLInputElement),this.progressBar=B(this.pageElement.querySelector("input[type=submit] + progress"),HTMLProgressElement),this.table=B(this.pageElement.querySelector("table.scan-result")),this.tableHead=B(this.table.querySelector("thead")),this.tableBody=B(this.table.querySelector("tbody")),this.listSelect=B(this.pageElement.querySelector(".list-choice select"),HTMLSelectElement),this.scanInfo=B(this.pageElement.querySelector(".scan-info")),this.scanType=this.form.elements.scan_type,this.userField=B(this.pageElement.querySelector(".user-choice input"),HTMLInputElement),this.userList=B(this.pageElement.querySelector(".selected-users")),this.autocomplete=B(this.pageElement.querySelector(".autocomplete")),this.userProgress={},this.appView=new A("public.api.bsky.app",!1),this.setupEvents()}setupEvents(){B(document.body.parentNode).addEventListener("click",(K)=>{this.hideAutocomplete()}),this.form.addEventListener("submit",(K)=>{if(K.preventDefault(),!this.scanStartTime)this.scanPostingStats();else this.stopScan()}),this.rangeInput.addEventListener("input",(K)=>{let Z=parseInt(this.rangeInput.value,10),Q=B(this.pageElement.querySelector("input[type=range] + label"));Q.innerText=Z==1?"1 day":`${Z} days`}),this.scanType.forEach((K)=>{K.addEventListener("click",(Z)=>{let Q=B(K,HTMLInputElement).value;if(B(this.pageElement.querySelector(".list-choice")).style.display=Q=="list"?"block":"none",B(this.pageElement.querySelector(".user-choice")).style.display=Q=="users"?"block":"none",Q=="users")this.userField.focus();this.table.style.display="none"})}),this.userField.addEventListener("input",()=>{this.onUserInput()}),this.userField.addEventListener("keydown",(K)=>{this.onUserKeyDown(K)})}show(){this.pageElement.style.display="block",this.fetchLists()}selectedDaysRange(){return parseInt(this.rangeInput.value,10)}async fetchLists(){let J=await accountAPI.loadUserLists(),K=J.sort((Z,Q)=>{let X=Z.name.toLocaleLowerCase(),z=Q.name.toLocaleLowerCase();return X.localeCompare(z)});for(let Z of J)this.listSelect.append(V("option",{value:Z.uri,text:Z.name+" "}))}onUserInput(){if(this.autocompleteTimer)clearTimeout(this.autocompleteTimer);let J=this.userField.value.trim();if(J.length==0){this.hideAutocomplete(),this.autocompleteTimer=void 0;return}this.autocompleteTimer=setTimeout(()=>this.fetchAutocomplete(J),100)}onUserKeyDown(J){if(J.key=="Enter"){if(J.preventDefault(),this.autocompleteIndex>=0)this.selectUser(this.autocompleteIndex)}else if(J.key=="Escape")this.hideAutocomplete();else if(J.key=="ArrowDown"&&this.autocompleteResults.length>0)J.preventDefault(),this.moveAutocomplete(1);else if(J.key=="ArrowUp"&&this.autocompleteResults.length>0)J.preventDefault(),this.moveAutocomplete(-1)}async fetchAutocomplete(J){let K=await accountAPI.autocompleteUsers(J),Z=new Set(Object.keys(this.selectedUsers));K=K.filter((Q)=>!Z.has(Q.did)),this.autocompleteResults=K,this.autocompleteIndex=-1,this.showAutocomplete()}showAutocomplete(){if(this.autocomplete.innerHTML="",this.autocomplete.scrollTop=0,this.autocompleteResults.length==0){this.hideAutocomplete();return}for(let[J,K]of this.autocompleteResults.entries()){let Z=this.makeUserRow(K);Z.addEventListener("mouseenter",()=>{this.highlightAutocomplete(J)}),Z.addEventListener("mousedown",(Q)=>{Q.preventDefault(),this.selectUser(J)}),this.autocomplete.append(Z)}this.autocomplete.style.top=this.userField.offsetHeight+"px",this.autocomplete.style.display="block",this.highlightAutocomplete(0)}hideAutocomplete(){this.autocomplete.style.display="none",this.autocompleteResults=[],this.autocompleteIndex=-1}moveAutocomplete(J){if(this.autocompleteResults.length==0)return;let K=this.autocompleteIndex+J;if(K<0)K=this.autocompleteResults.length-1;else if(K>=this.autocompleteResults.length)K=0;this.highlightAutocomplete(K)}highlightAutocomplete(J){this.autocompleteIndex=J,this.autocomplete.querySelectorAll(".user-row").forEach((Z,Q)=>{Z.classList.toggle("hover",Q==J)})}selectUser(J){let K=this.autocompleteResults[J];if(!K)return;this.selectedUsers[K.did]=K;let Z=this.makeUserRow(K,!0);this.userList.append(Z),this.userField.value="",this.hideAutocomplete()}makeUserRow(J,K=!1){let Z=V("div.user-row");if(Z.dataset.did=J.did,Z.append(V("img.avatar",{src:J.avatar}),V("span.name",{text:J.displayName||"–"}),V("span.handle",{text:J.handle})),K){let Q=V("a.remove",{href:"#",text:"✕"});Q.addEventListener("click",(X)=>{X.preventDefault(),Z.remove(),delete this.selectedUsers[J.did]}),Z.append(Q)}return Z}async scanPostingStats(){let J=new Date().getTime(),K=this.selectedDaysRange(),Z=this.scanType.value,Q=(X)=>{if(this.scanStartTime!=J)return{cancel:!0};this.updateProgress(X,J)};if(Z=="home"){this.startScan(J,K);let X=await accountAPI.loadHomeTimeline(K,{onPageLoad:Q,keepLastPage:!0});this.updateResultsTable(X,J,K)}else if(Z=="list"){let X=this.listSelect.value;if(!X)return;this.startScan(J,K);let z=await accountAPI.loadListTimeline(X,K,{onPageLoad:Q,keepLastPage:!0});this.updateResultsTable(z,J,K,{showReposts:!1})}else if(Z=="users"){let X=Object.keys(this.selectedUsers);if(X.length==0)return;this.startScan(J,K),this.resetUserProgress(X);let z=X.map((F)=>this.appView.loadUserTimeline(F,K,{filter:"posts_and_author_threads",onPageLoad:(H)=>{if(this.scanStartTime!=J)return{cancel:!0};this.updateUserProgress(F,H,J,K)},keepLastPage:!0})),G=(await Promise.all(z)).flat();this.updateResultsTable(G,J,K,{showTotal:!1,showPercentages:!1,countFetchedDays:!1,users:Object.values(this.selectedUsers)})}else{this.startScan(J,K);let X=await accountAPI.loadUserTimeline(accountAPI.user.did,K,{filter:"posts_no_replies",onPageLoad:Q,keepLastPage:!0});this.updateResultsTable(X,J,K,{showTotal:!1,showPercentages:!1})}}updateProgress(J,K){let Z=J.at(-1);if(!Z)return;let Q=l(Z),X=(K-Q)/86400/1000;this.progressBar.value=X}resetUserProgress(J){this.userProgress={};for(let K of J)this.userProgress[K]={pages:0,progress:0}}updateUserProgress(J,K,Z,Q){let X=K.at(-1);if(!X)return;let z=l(X),W=(Z-z)/86400/1000;this.userProgress[J].pages+=1,this.userProgress[J].progress=Math.min(W/Q,1);let G=Object.values(this.userProgress).map((M)=>M.pages/M.progress),F=G.filter((M)=>!isNaN(M)),H=F.reduce((M,m)=>M+m)/F.length*G.length,x=Object.values(this.userProgress).map((M)=>M.pages).reduce((M,m)=>M+m);this.progressBar.value=Math.max(this.progressBar.value,x/H*Q)}sortUserRows(J,K){let Z=J.own+J.reposts,Q=K.own+K.reposts;if(Z<Q)return 1;else if(Z>Q)return-1;else return 0}async updateResultsTable(J,K,Z,Q={}){if(this.scanStartTime!=K)return;if(new Date().getTime()-K<100)await new Promise(($)=>setTimeout($,100));let z={},W=0,G=0,F=0,H=J.at(-1);if(!H){this.stopScan();return}let x;if(Q.countFetchedDays!==!1){let $=l(H),S=(K-$)/86400/1000;if(Math.ceil(S)<Z)this.scanInfo.innerText=`\uD83D\uDD53 Showing data from ${Math.round(S)} days (the timeline only goes that far):`,this.scanInfo.style.display="block";x=Math.min(Z,S)}else x=Z;let M=K-Z*86400*1000;if(J=J.filter(($)=>l($)>M),J.reverse(),Q.users)for(let $ of Q.users)z[$.handle]={handle:$.handle,own:0,reposts:0,avatar:$.avatar};let m=new Set;for(let $ of J){if($.reply){if(!m.has($.reply.parent.uri))continue}let S=$.reason?$.reason.by:$.post.author,s=S.handle;if(z[s]=z[s]??{handle:s,own:0,reposts:0,avatar:S.avatar},W+=1,$.reason)z[s].reposts+=1,G+=1;else z[s].own+=1,F+=1,m.add($.post.uri)}let c=V("tr");if(Q.showReposts!==!1)c.append(V("th",{text:"#"}),V("th",{text:"Handle"}),V("th",{text:"All posts /d"}),V("th",{text:"Own posts /d"}),V("th",{text:"Reposts /d"}));else c.append(V("th",{text:"#"}),V("th",{text:"Handle"}),V("th",{text:"Posts /d"}));if(Q.showPercentages!==!1)c.append(V("th",{text:"% of timeline"}));if(this.tableHead.append(c),Q.showTotal!==!1){let $=V("tr.total");if($.append(V("td.no",{text:""}),V("td.handle",{text:"Total:"}),Q.showReposts!==!1?V("td",{text:(W/x).toFixed(1)}):"",V("td",{text:(F/x).toFixed(1)}),Q.showReposts!==!1?V("td",{text:(G/x).toFixed(1)}):""),Q.showPercentages!==!1)$.append(V("td.percent",{text:""}));this.tableBody.append($)}let t=Object.values(z).sort(this.sortUserRows);for(let $=0;$<t.length;$++){let S=t[$],s=V("tr");if(s.append(V("td.no",{text:$+1}),V("td.handle",{html:`<img class="avatar" src="${S.avatar}"> <a href="https://bsky.app/profile/${S.handle}" target="_blank">${S.handle}</a>`}),Q.showReposts!==!1?V("td",{text:((S.own+S.reposts)/x).toFixed(1)}):"",V("td",{text:S.own>0?(S.own/x).toFixed(1):"–"}),Q.showReposts!==!1?V("td",{text:S.reposts>0?(S.reposts/x).toFixed(1):"–"}):""),Q.showPercentages!==!1)s.append(V("td.percent",{text:((S.own+S.reposts)*100/W).toFixed(1)+"%"}));this.tableBody.append(s)}this.table.style.display="table",this.stopScan()}startScan(J,K){this.submitButton.value="Cancel",this.progressBar.max=K,this.progressBar.value=0,this.progressBar.style.display="inline",this.table.style.display="none",this.tableHead.innerHTML="",this.tableBody.innerHTML="",this.scanStartTime=J,this.scanInfo.style.display="none"}stopScan(){this.submitButton.value="Start scan",this.scanStartTime=void 0,this.progressBar.style.display="none"}}class lJ{constructor(){this.pageElement=v("thread")}show(){document.title="Notifications - Skythread",H0();let J=!1,K=!1,Z=!1,Q;Paginator.loadInPages((X)=>{if(J||Z)return;J=!0,accountAPI.loadMentions(Q).then((z)=>{let W=z.posts.map((G)=>new k(G));if(W.length>0){if(!K){n(),K=!0;let G=V("header"),F=V("h2",{text:"Replies & Mentions:"});G.append(F),this.pageElement.appendChild(G),this.pageElement.classList.add("notifications")}for(let G of W){if(G.parentReference){let H=V("p.back");H.innerHTML='<i class="fa-solid fa-reply"></i> ';let{repo:x,rkey:M}=D(G.parentReference.uri),m=J0(x,M),c=V("a",{href:m});if(H.append(c),x==accountAPI.user.did)c.innerText="Reply to you";else c.innerText="Reply",api.fetchHandleForDid(x).then((t)=>{c.innerText=`Reply to @${t}`});this.pageElement.appendChild(H)}let F=new f(G,"feed").buildElement();this.pageElement.appendChild(F)}}if(J=!1,Q=z.cursor,!Q)Z=!0;else if(W.length==0)X()}).catch((z)=>{n(),console.log(z),J=!1})})}}class uJ{scanStartTime;constructor(){this.pageElement=v("like_stats_page"),this.rangeInput=B(this.pageElement.querySelector('input[type="range"]'),HTMLInputElement),this.submitButton=B(this.pageElement.querySelector('input[type="submit"]'),HTMLInputElement),this.progressBar=B(this.pageElement.querySelector("input[type=submit] + progress"),HTMLProgressElement),this.receivedTable=B(this.pageElement.querySelector(".received-likes"),HTMLTableElement),this.givenTable=B(this.pageElement.querySelector(".given-likes"),HTMLTableElement),this.appView=new A("public.api.bsky.app",!1),this.setupEvents(),this.progressPosts=0,this.progressLikeRecords=0,this.progressPostLikes=0}setupEvents(){B(this.pageElement.querySelector("form")).addEventListener("submit",(J)=>{if(J.preventDefault(),!this.scanStartTime)this.findLikes();else this.stopScan()}),this.rangeInput.addEventListener("input",(J)=>{let K=parseInt(this.rangeInput.value,10),Z=B(this.pageElement.querySelector("input[type=range] + label"));Z.innerText=K==1?"1 day":`${K} days`})}selectedDaysRange(){return parseInt(this.rangeInput.value,10)}show(){this.pageElement.style.display="block"}async findLikes(){this.submitButton.value="Cancel";let J=this.selectedDaysRange();this.resetProgress(),this.progressBar.style.display="inline";let K=new Date().getTime();this.scanStartTime=K,this.receivedTable.style.display="none",this.givenTable.style.display="none";let Z=this.fetchGivenLikes(J),Q=await this.fetchReceivedLikes(J),X=this.sumUpReceivedLikes(Q),z=this.getTopEntries(X);await this.renderResults(z,this.receivedTable);let W=await Z,G=this.sumUpGivenLikes(W),F=this.getTopEntries(G),H=await appView.getRequest("app.bsky.actor.getProfiles",{actors:F.map((x)=>x.did)});for(let x of H.profiles){let M=F.find((m)=>m.did==x.did);M.handle=x.handle,M.avatar=x.avatar}await this.renderResults(F,this.givenTable),this.receivedTable.style.display="table",this.givenTable.style.display="table",this.submitButton.value="Start scan",this.progressBar.style.display="none",this.scanStartTime=void 0}async fetchGivenLikes(J){let K=this.scanStartTime;return await accountAPI.fetchAll("com.atproto.repo.listRecords",{params:{repo:accountAPI.user.did,collection:"app.bsky.feed.like",limit:100},field:"records",breakWhen:(Z)=>Date.parse(Z.value.createdAt)<K-86400*J*1000,onPageLoad:(Z)=>{let Q=Z.at(-1);if(!Q)return;let X=Date.parse(Q.value.createdAt),z=(K-X)/86400/1000;this.updateProgress({likeRecords:Math.min(1,z/J)})}})}async fetchReceivedLikes(J){let K=this.scanStartTime,Q=(await this.appView.loadUserTimeline(accountAPI.user.did,J,{filter:"posts_with_replies",onPageLoad:(z)=>{let W=z.at(-1);if(!W)return;let G=l(W),F=(K-G)/86400/1000;this.updateProgress({posts:Math.min(1,F/J)})}})).filter((z)=>!z.reason&&z.post.likeCount>0),X=[];for(let z=0;z<Q.length;z+=10){let W=Q.slice(z,z+10);this.updateProgress({postLikes:z/Q.length});let G=W.map((H)=>{return this.appView.fetchAll("app.bsky.feed.getLikes",{params:{uri:H.post.uri,limit:100},field:"likes"})}),F=await Promise.all(G);X=X.concat(F)}return this.updateProgress({postLikes:1}),X.flat()}sumUpReceivedLikes(J){let K={};for(let Z of J){let Q=Z.actor.handle;if(!K[Q])K[Q]={handle:Q,count:0,avatar:Z.actor.avatar};K[Q].count+=1}return K}sumUpGivenLikes(J){let K={};for(let Z of J){let Q=D(Z.value.subject.uri).repo;if(!K[Q])K[Q]={did:Q,count:0};K[Q].count+=1}return K}getTopEntries(J){return Object.entries(J).sort(this.sortResults).map((K)=>K[1]).slice(0,25)}async renderResults(J,K){let Z=B(K.querySelector("tbody"));Z.innerHTML="";for(let[Q,X]of J.entries()){let z=V("tr");z.append(V("td.no",{text:Q+1}),V("td.handle",{html:`<img class="avatar" src="${X.avatar}"> <a href="https://bsky.app/profile/${X.handle}" target="_blank">${X.handle}</a>`}),V("td.count",{text:X.count})),Z.append(z)}}resetProgress(){this.progressBar.value=0,this.progressPosts=0,this.progressLikeRecords=0,this.progressPostLikes=0}updateProgress(J){if(J.posts)this.progressPosts=J.posts;if(J.likeRecords)this.progressLikeRecords=J.likeRecords;if(J.postLikes)this.progressPostLikes=J.postLikes;let K=0.1*this.progressPosts+0.65*this.progressLikeRecords+0.25*this.progressPostLikes;this.progressBar.value=K}sortResults(J,K){if(J[1].count<K[1].count)return 1;else if(J[1].count>K[1].count)return-1;else return 0}stopScan(){this.submitButton.value="Start scan",this.progressBar.style.display="none",this.scanStartTime=void 0}}class iJ{fetchStartTime;importTimer;lycanImportStatus;constructor(){this.pageElement=v("private_search_page"),this.header=B(this.pageElement.querySelector("h2")),this.rangeInput=B(this.pageElement.querySelector('input[type="range"]'),HTMLInputElement),this.submitButton=B(this.pageElement.querySelector('input[type="submit"]'),HTMLInputElement),this.progressBar=B(this.pageElement.querySelector('input[type="submit"] + progress'),HTMLProgressElement),this.archiveStatus=B(this.pageElement.querySelector(".archive-status")),this.searchLine=B(this.pageElement.querySelector(".search")),this.searchField=B(this.pageElement.querySelector(".search-query"),HTMLInputElement),this.searchForm=B(this.pageElement.querySelector(".search-form"),HTMLFormElement),this.results=B(this.pageElement.querySelector(".results")),this.timelineSearch=B(this.pageElement.querySelector(".timeline-search")),this.timelineSearchForm=B(this.pageElement.querySelector(".timeline-search form"),HTMLFormElement),this.searchCollections=B(this.pageElement.querySelector(".search-collections")),this.lycanImportSection=B(this.pageElement.querySelector(".lycan-import")),this.lycanImportForm=B(this.pageElement.querySelector(".lycan-import form"),HTMLFormElement),this.importProgress=B(this.pageElement.querySelector(".import-progress")),this.importProgressBar=B(this.pageElement.querySelector(".import-progress progress"),HTMLProgressElement),this.importStatusLabel=B(this.pageElement.querySelector(".import-status")),this.importStatusPosition=B(this.pageElement.querySelector(".import-progress output")),this.isCheckingStatus=!1,this.timelinePosts=[],this.setupEvents();let J=new URLSearchParams(location.search);if(this.mode=J.get("mode"),this.lycanMode=J.get("lycan"),this.lycanMode=="local")this.localLycan=new A("http://localhost:3000",!1)}setupEvents(){this.timelineSearchForm.addEventListener("submit",(J)=>{if(J.preventDefault(),!this.fetchStartTime)this.fetchTimeline();else this.stopFetch()}),this.rangeInput.addEventListener("input",(J)=>{let K=parseInt(this.rangeInput.value,10),Z=B(this.pageElement.querySelector("input[type=range] + label"));Z.innerText=K==1?"1 day":`${K} days`}),this.searchField.addEventListener("keydown",(J)=>{if(J.key=="Enter"){J.preventDefault();let K=this.searchField.value.trim().toLowerCase();if(this.mode=="likes")this.searchInLycan(K);else this.searchInTimeline(K)}}),this.lycanImportForm.addEventListener("submit",(J)=>{J.preventDefault(),this.startLycanImport()})}selectedDaysRange(){return parseInt(this.rangeInput.value,10)}show(){if(this.pageElement.style.display="block",this.mode=="likes")this.header.innerText="Archive search",this.timelineSearch.style.display="none",this.searchCollections.style.display="block",this.searchLine.style.display="block",this.lycanImportSection.style.display="none",this.checkLycanImportStatus();else this.header.innerText="Timeline search",this.timelineSearch.style.display="block",this.searchCollections.style.display="none",this.lycanImportSection.style.display="none"}async checkLycanImportStatus(){if(this.isCheckingStatus)return;this.isCheckingStatus=!0;try{let J=await this.getImportStatus();this.showImportStatus(J)}catch(J){this.showImportError(`Couldn't check import status: ${J}`)}finally{this.isCheckingStatus=!1}}async getImportStatus(){if(this.localLycan)return await this.localLycan.getRequest("blue.feeds.lycan.getImportStatus",{user:accountAPI.user.did});else return await accountAPI.getRequest("blue.feeds.lycan.getImportStatus",null,{headers:{"atproto-proxy":"did:web:lycan.feeds.blue#lycan"}})}showImportStatus(J){if(console.log(J),!J.status){this.showImportError("Error checking import status");return}if(this.lycanImportStatus=J.status,J.status=="not_started")this.lycanImportSection.style.display="block",this.lycanImportForm.style.display="block",this.importProgress.style.display="none",this.searchField.disabled=!0,this.stopImportTimer();else if(J.status=="in_progress"||J.status=="scheduled"||J.status=="requested")this.lycanImportSection.style.display="block",this.lycanImportForm.style.display="none",this.importProgress.style.display="block",this.searchField.disabled=!0,this.showImportProgress(J),this.startImportTimer();else if(J.status=="finished")this.lycanImportForm.style.display="none",this.importProgress.style.display="block",this.searchField.disabled=!1,this.showImportProgress({status:"finished",progress:1}),this.stopImportTimer();else this.showImportError("Error checking import status"),this.stopImportTimer()}showImportProgress(J){let K=Math.max(0,Math.min(J.progress||0));this.importProgressBar.value=K,this.importProgressBar.style.display="inline";let Z=Math.round(K*100);if(this.importStatusPosition.innerText=`${Z}%`,J.progress==1)this.importStatusLabel.innerText="Import complete ✓";else if(J.position){let Q=new Date(J.position).toLocaleString(window.dateLocale,{day:"numeric",month:"short",year:"numeric"});this.importStatusLabel.innerText=`Downloaded data until: ${Q}`}else if(J.status=="requested")this.importStatusLabel.innerText="Requesting import…";else this.importStatusLabel.innerText="Import started…"}showImportError(J){this.lycanImportSection.style.display="block",this.lycanImportForm.style.display="none",this.importProgress.style.display="block",this.searchField.disabled=!0,this.importStatusLabel.innerText=J,this.stopImportTimer()}startImportTimer(){if(this.importTimer)return;this.importTimer=setInterval(()=>{this.checkLycanImportStatus()},3000)}stopImportTimer(){if(this.importTimer)clearInterval(this.importTimer),this.importTimer=void 0}async startLycanImport(){this.showImportStatus({status:"requested"});try{if(this.localLycan)await this.localLycan.postRequest("blue.feeds.lycan.startImport",{user:accountAPI.user.did});else await accountAPI.postRequest("blue.feeds.lycan.startImport",null,{headers:{"atproto-proxy":"did:web:lycan.feeds.blue#lycan"}});this.startImportTimer()}catch(J){console.error("Failed to start Lycan import",J),this.showImportError(`Import failed: ${J}`)}}async fetchTimeline(){this.submitButton.value="Cancel";let J=this.selectedDaysRange();this.progressBar.max=J,this.progressBar.value=0,this.progressBar.style.display="inline";let K=new Date().getTime();this.fetchStartTime=K;let Z=await accountAPI.loadHomeTimeline(J,{onPageLoad:(z)=>{if(this.fetchStartTime!=K)return{cancel:!0};this.updateProgress(z,K)}});if(this.fetchStartTime!=K)return;let Q=Z.at(-1),X;if(Q){let z=l(Q);X=Math.round((K-z)/86400/1000)}else X=0;this.timelinePosts=Z,this.archiveStatus.innerText="Timeline archive fetched: "+(X==1?"1 day":`${X} days`),this.searchLine.style.display="block",this.submitButton.value="Fetch timeline",this.progressBar.style.display="none",this.fetchStartTime=void 0}searchInTimeline(J){if(this.results.innerHTML="",J.length==0)return;let K=this.timelinePosts.filter((Z)=>Z.post.record.text.toLowerCase().includes(J)).map((Z)=>k.parseFeedPost(Z));for(let Z of K){let Q=new f(Z,"feed").buildElement();this.results.appendChild(Q)}}searchInLycan(J){if(J.length==0||this.lycanImportStatus!="finished")return;this.results.innerHTML="",this.lycanImportSection.style.display="none";let K=this.searchForm.elements.collection.value,Z=V("p",{text:"..."});this.results.append(Z);let Q=!1,X=!1,z,W=!1;Paginator.loadInPages(async()=>{if(Q||W)return;Q=!0;let G;if(this.localLycan){let x={collection:K,query:J,user:accountAPI.user.did};if(z)x.cursor=z;G=await this.localLycan.getRequest("blue.feeds.lycan.searchPosts",x)}else{let x={collection:K,query:J};if(z)x.cursor=z;G=await accountAPI.getRequest("blue.feeds.lycan.searchPosts",x,{headers:{"atproto-proxy":"did:web:lycan.feeds.blue#lycan"}})}if(G.posts.length==0){let x=V("p.results-end",{text:X?"No more results.":"No results."});Z.remove(),this.results.append(x),Q=!1,W=!0;return}let H=(await accountAPI.loadPosts(G.posts)).map((x)=>new k(x));if(!X)Z.remove(),X=!0;for(let x of H){let M=new f(x,"feed"),m=M.buildElement();this.results.appendChild(m),M.highlightSearchResults(G.terms)}if(Q=!1,z=G.cursor,!z)W=!0,this.results.append("No more results.")})}updateProgress(J,K){let Z=J.at(-1);if(!Z)return;let Q=l(Z),X=(K-Q)/86400/1000;this.progressBar.value=X}stopFetch(){this.submitButton.value="Fetch timeline",this.progressBar.style.display="none",this.fetchStartTime=void 0}}function D6(){window.dateLocale=localStorage.getItem("locale")||void 0,window.isIncognito=!!localStorage.getItem("incognito"),window.biohazardEnabled=JSON.parse(localStorage.getItem("biohazard")??"null"),window.loginDialog=B(document.querySelector("#login")),window.avatarPreloader=R6(),window.accountMenu=new TJ,window.threadPage=new mJ,window.postingStatsPage=new pJ,window.likeStatsPage=new uJ,window.notificationsPage=new lJ,window.privateSearchPage=new iJ,B(document.querySelector("#search form")).addEventListener("submit",(J)=>{J.preventDefault(),A6()});for(let J of document.querySelectorAll(".dialog")){let K=B(J.querySelector(".close"));J.addEventListener("click",(Z)=>{if(Z.target===Z.currentTarget&&K&&K.offsetHeight>0)g0(J);else Z.stopPropagation()}),K?.addEventListener("click",(Z)=>{g0(J)})}if(B(document.querySelector("#login .info a")).addEventListener("click",(J)=>{J.preventDefault(),h6()}),B(document.querySelector("#login form")).addEventListener("submit",(J)=>{J.preventDefault(),P6()}),B(document.querySelector("#biohazard_show")).addEventListener("click",(J)=>{if(J.preventDefault(),window.biohazardEnabled=!0,localStorage.setItem("biohazard","true"),window.loadInfohazard)window.loadInfohazard(),window.loadInfohazard=void 0;let K=B(J.target);g0(K.closest(".dialog"))}),B(document.querySelector("#biohazard_hide")).addEventListener("click",(J)=>{J.preventDefault(),window.biohazardEnabled=!1,localStorage.setItem("biohazard","false"),accountMenu.toggleMenuButtonCheck("biohazard",!1);for(let Z of document.querySelectorAll("p.hidden-replies, .content > .post.blocked, .blocked > .load-post"))B(Z).style.display="none";let K=B(J.target);g0(K.closest(".dialog"))}),window.appView=new A("api.bsky.app",!1),window.blueAPI=new A("blue.mackuba.eu",!1),window.accountAPI=new A(void 0,!0),accountAPI.isLoggedIn)if(accountAPI.host=accountAPI.user.pdsEndpoint,accountMenu.hideMenuButton("login"),!isIncognito)window.api=accountAPI,accountMenu.showLoggedInStatus(!0,api.user.avatar);else window.api=appView,accountMenu.showLoggedInStatus("incognito"),accountMenu.toggleMenuButtonCheck("incognito",!0);else window.api=appView,accountMenu.hideMenuButton("logout"),accountMenu.hideMenuButton("incognito");accountMenu.toggleMenuButtonCheck("biohazard",window.biohazardEnabled!==!1),b6()}function b6(){let J=new URLSearchParams(location.search),{q:K,author:Z,post:Q,quotes:X,hash:z,page:W}=Object.fromEntries(J);if(X)H0(),_6(decodeURIComponent(X));else if(z)H0(),N6(decodeURIComponent(z));else if(K)H0(),threadPage.loadThreadByURL(decodeURIComponent(K));else if(Z&&Q)H0(),threadPage.loadThreadById(decodeURIComponent(Z),decodeURIComponent(Q));else if(W)E1(W);else L6()}function R6(){return new IntersectionObserver((J,K)=>{for(let Z of J)if(Z.isIntersecting){let Q=Z.target;Q.removeAttribute("lazy"),K.unobserve(Q)}},{rootMargin:"1000px 0px"})}function H0(){v("loader").style.display="block"}function n(){v("loader").style.display="none"}function L6(){let J=v("search"),K=B(J.querySelector("input[type=text]"));J.style.visibility="visible",K.focus()}function G0(J){J.style.visibility="visible",v("thread").classList.add("overlay"),J.querySelector("input[type=text]")?.focus()}function g0(J){J.style.visibility="hidden",J.classList.remove("expanded"),v("thread").classList.remove("overlay");for(let K of J.querySelectorAll("input[type=text]"))K.value=""}function h6(){v("login").classList.toggle("expanded")}function P6(){let J=v("login_handle",HTMLInputElement),K=v("login_password",HTMLInputElement),Z=v("login_submit"),Q=v("cloudy"),X=B(loginDialog.querySelector(".close"));if(Z.style.display=="none")return;J.blur(),K.blur(),Z.style.display="none",Q.style.display="inline-block";let z=J.value.trim(),W=K.value.trim();y6(z,W).then((G)=>{window.api=G,window.accountAPI=G,g0(loginDialog),Z.style.display="inline",Q.style.display="none",X.style.display="inline",accountMenu.loadCurrentUserAvatar(),accountMenu.showMenuButton("logout"),accountMenu.showMenuButton("incognito"),accountMenu.hideMenuButton("login");let H=new URLSearchParams(location.search).get("page");if(H)E1(H)}).catch((G)=>{if(Z.style.display="inline",Q.style.display="none",console.log(G),G.code==401&&G.json.error=="AuthFactorTokenRequired")alert('Please log in using an "app password" if you have 2FA enabled.');else window.setTimeout(()=>alert(G),10)})}async function y6(J,K){let Z;if(J.match(/^did:/))Z=await $0.pdsEndpointForDid(J);else if(J.match(/^[^@]+@[^@]+$/))Z="bsky.social";else if(J.match(/^@?[\w\-]+(\.[\w\-]+)+$/)){J=J.replace(/^@/,"");let X=await appView.resolveHandle(J);Z=await $0.pdsEndpointForDid(X)}else throw"Please enter your handle or DID.";let Q=new A(Z,!0);return await Q.logIn(J,K),Q}function gJ(){accountAPI.resetTokens(),localStorage.removeItem("incognito"),location.reload()}function A6(){let J=v("search"),Z=B(J.querySelector("input[name=q]"),HTMLInputElement).value.trim();if(!Z)return;if(Z.startsWith("at://")){let Q=new URL(X0());Q.searchParams.set("q",Z),location.assign(Q.toString());return}if(Z.match(/^#?((\p{Letter}|\p{Number})+)$/u)){let Q=new URL(X0());Q.searchParams.set("hash",encodeURIComponent(Z.replace(/^#/,""))),location.assign(Q.toString());return}try{let[Q,X]=A.parsePostURL(Z),z=J0(Q,X);location.assign(z)}catch(Q){console.log(Q),alert(Q.message||"This is not a valid URL or hashtag")}}function E1(J){if(!accountAPI.isLoggedIn){G0(loginDialog),B(loginDialog.querySelector(".close")).style.display="none";return}if(J=="notif")window.notificationsPage.show();else if(J=="posting_stats")window.postingStatsPage.show();else if(J=="like_stats")window.likeStatsPage.show();else if(J=="search")window.privateSearchPage.show()}function cJ(J){document.title=`${J.author.displayName}: "${J.text}" - Skythread`}function N6(J){J=J.replace(/^\#/,""),document.title=`#${J} - Skythread`;let K=!1,Z=!1,Q=!1,X;Paginator.loadInPages(()=>{if(K||Q)return;K=!0,api.getHashtagFeed(J,X).then((z)=>{let W=z.posts.map((G)=>new k(G));if(!Z){n();let G=V("header"),F=V("h2",{text:W.length>0?`Posts tagged: #${J}`:`No posts tagged #${J}.`});G.append(F),v("thread").appendChild(G),v("thread").classList.add("hashtag")}for(let G of W){let F=new f(G,"feed").buildElement();v("thread").appendChild(F)}if(K=!1,Z=!0,X=z.cursor,!X||W.length==0)Q=!0}).catch((z)=>{n(),console.log(z),K=!1})})}function _6(J){let K=!1,Z=!1,Q,X=!1;Paginator.loadInPages(()=>{if(K||X)return;K=!0,blueAPI.getQuotes(J,Q).then((z)=>{api.loadPosts(z.posts).then((W)=>{let G=W.map((F)=>new k(F));if(!Z){n();let F=V("header"),H;if(z.quoteCount>1)H=V("h2",{text:`${z.quoteCount} quotes:`});else if(z.quoteCount==1)H=V("h2",{text:"1 quote:"});else H=V("h2",{text:"No quotes found."});F.append(H),v("thread").appendChild(F),v("thread").classList.add("quotes")}for(let F of G){let H=new f(F,"quotes").buildElement();v("thread").appendChild(H)}if(K=!1,Z=!0,Q=z.cursor,!Q||G.length==0)X=!0}).catch((W)=>{n(),console.log(W),K=!1})}).catch((z)=>{n(),console.log(z),K=!1})})}window.init=D6;window.BlueskyAPI=A;})();

//# debugId=214CA55974B1DB5F64756E2164756E21
//# sourceMappingURL=skythread.js.map
